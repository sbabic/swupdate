<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Handlers &mdash; Embedded Software Update Documentation 2025.12 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=86f27845" />

  
    <link rel="shortcut icon" href="_static/SWUpdate.ico"/>
  
        <script src="_static/jquery.js?v=8dae8fb0"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=50a9be24"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Mongoose daemon mode" href="mongoose.html" />
    <link rel="prev" title="Asymmetrically Encrypted Update Images" href="asym_encrypted_images.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Embedded Software Update Documentation
          </a>
              <div class="version">
                2025.12
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Software Management on embedded systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="licensing.html">License</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="swupdate.html">SWUpdate: software update for embedded system</a></li>
<li class="toctree-l1"><a class="reference internal" href="scenarios.html">Update strategy examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="sw-description.html">SWUpdate: syntax and tags with the default parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="signed_images.html">Update images from verified source</a></li>
<li class="toctree-l1"><a class="reference internal" href="encrypted_images.html">Symmetrically Encrypted Update Images</a></li>
<li class="toctree-l1"><a class="reference internal" href="asym_encrypted_images.html">Asymmetrically Encrypted Update Images</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Handlers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supplied-handlers">Supplied handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-own-handlers">Creating own handlers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dummy-handler">Dummy Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ubi-volume-handler">UBI Volume Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#atomic-volume-renaming">atomic volume renaming</a></li>
<li class="toctree-l3"><a class="reference internal" href="#volume-auto-resize">volume auto resize</a></li>
<li class="toctree-l3"><a class="reference internal" href="#volume-always-remove">volume always remove</a></li>
<li class="toctree-l3"><a class="reference internal" href="#size-properties">size properties</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#lua-handlers">Lua Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lua-handler-interface-specification">Lua Handler Interface Specification</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#shell-script-handler">Shell script handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lua-script-handler">Lua script handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remote-handler">Remote handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#swu-forwarder">SWU forwarder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rdiff-handler">rdiff handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ucfw-handler">ucfw handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ssbl-handler">SSBL Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#readback-handler">Readback Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#copy-handler">Copy handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bootloader-handler">Bootloader handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#archive-handler">Archive handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disk-partitioner">Disk partitioner</a></li>
<li class="toctree-l2"><a class="reference internal" href="#toggleboot-handler">Toggleboot Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gpt-partition-handler">GPT Partition Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gpt-partition-installer">GPT Partition Installer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpt-partition-swap">GPT Partition Swap</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#diskformat-handler">Diskformat Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#unique-uuid-handler">Unique UUID Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#btrfs-handler">BTRFS Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#btrfs-partition-handler">BTRFS Partition Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#btrfs-snapshot-handler">BTRFS Snapshot Handler</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generic-executor-handler">Generic Executor Handler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#delta-update-handler">Delta Update Handler</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memory-issue-with-zchunk">Memory issue with zchunk</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#docker-handlers">Docker Handlers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#docker-load-image">Docker Load Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-remove-image">Docker Remove Image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-delete-unused-images">Docker Delete Unused Images</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-container-create">Docker: container create</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-remove-container">Docker Remove Container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#docker-start-stop-containers">Docker : Start / Stop containers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="mongoose.html">Mongoose daemon mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="suricatta.html">Suricatta daemon mode</a></li>
<li class="toctree-l1"><a class="reference internal" href="hawkbit-setup.html">Config for hawkBit under SSL/TLS using private CA / sub CA</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-ipc-interface.html">SWUpdate: API for external programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress.html">Getting information on running update</a></li>
<li class="toctree-l1"><a class="reference internal" href="bindings.html">Language Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="bootloader_interface.html">Bootloader Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="building-with-yocto.html">meta-swupdate: building with Yocto</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-best-practise.html">SWUpdate Best Practice</a></li>
<li class="toctree-l1"><a class="reference internal" href="delta-update.html">Delta Update with SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="swupdate-client.html">swupdate-client</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-progress.html">swupdate-progress</a></li>
<li class="toctree-l1"><a class="reference internal" href="swupdate-ipc.html">swupdate-ipc</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="help_and_support.html">Help and support</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing to SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="improvement_proposals.html">Proposals to improve SWUpdate</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="previous-releases.html">Documentation for previous releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Embedded Software Update Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Handlers</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/handlers.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="handlers">
<h1>Handlers<a class="headerlink" href="#handlers" title="Link to this heading"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>It is quite difficult to foresee all possible installation cases.
Instead of trying to find all use cases, SWUpdate let the
developer free to add his own installer (that is, a new <strong>handler</strong>),
that must be responsible to install an image of a certain type.
An image is marked to be of a defined type to be installed with
a specific handler.</p>
<p>The parser make the connection between ‘image type’ and ‘handler’.
It fills a table containing the list of images to be installed
with the required handler to execute the installation. Each image
can have a different installer.</p>
</section>
<section id="supplied-handlers">
<h2>Supplied handlers<a class="headerlink" href="#supplied-handlers" title="Link to this heading"></a></h2>
<dl class="simple">
<dt>In mainline there are the handlers for the most common cases. They include:</dt><dd><ul class="simple">
<li><p>flash devices in raw mode (both NOR and NAND)</p></li>
<li><p>UBI volumes</p></li>
<li><p>UBI volumes partitioner</p></li>
<li><p>raw flashes handler (NAND, NOR, SPI-NOR, CFI interface)</p></li>
<li><p>disk partitioner</p></li>
<li><p>raw devices, such as a SD Card partition</p></li>
<li><p>bootloader (U-Boot, GRUB, EFI Boot Guard) environment</p></li>
<li><p>Lua scripts handler</p></li>
<li><p>shell scripts handler</p></li>
<li><p>rdiff handler</p></li>
<li><p>readback handler</p></li>
<li><p>archive (zo, tarballs) handler</p></li>
<li><p>remote handler</p></li>
<li><p>microcontroller update handler</p></li>
</ul>
</dd>
</dl>
<p>For example, if an image is marked to be updated into a UBI volume,
the parser must fill a supplied table setting “ubi” as required handler,
and filling the other fields required for this handler: name of volume, size,
and so on.</p>
</section>
<section id="creating-own-handlers">
<h2>Creating own handlers<a class="headerlink" href="#creating-own-handlers" title="Link to this heading"></a></h2>
<p>SWUpdate can be extended with new handlers. The user needs to register his own
handler with the core and he must provide the callback that SWUpdate uses when
an image required to be installed with the new handler.</p>
<p>The prototype for the callback is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">my_handler</span><span class="p">(</span><span class="n">struct</span> <span class="n">img_type</span> <span class="o">*</span><span class="n">img</span><span class="p">,</span>
        <span class="n">void</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__unused__</span><span class="p">))</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>The most important parameter is the pointer to a struct img_type. It describes
a single image and inform the handler where the image must be installed. The
file descriptor of the incoming stream set to the start of the image to be installed is also
part of the structure.</p>
<p>The structure <em>img_type</em> contains the file descriptor of the stream pointing to the first byte
of the image to be installed. The handler must read the whole image, and when it returns
back SWUpdate can go on with the next image in the stream.</p>
<p>The data parameter is usually a pointer that was registered with the
handler. For script handlers it is instead a pointer to a <code class="docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">script_handler_data</span></code> which contains a <code class="docutils literal notranslate"><span class="pre">script_fn</span></code> enum value,
indicating the current installation phase, and the registered data
pointer.</p>
<p>SWUpdate provides a general function to extract data from the stream and copy
to somewhere else:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">copyfile</span><span class="p">(</span><span class="nb">int</span> <span class="n">fdin</span><span class="p">,</span> <span class="nb">int</span> <span class="n">fdout</span><span class="p">,</span> <span class="nb">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">long</span> <span class="o">*</span><span class="n">offs</span><span class="p">,</span>
        <span class="nb">int</span> <span class="n">skip_file</span><span class="p">,</span> <span class="nb">int</span> <span class="n">compressed</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">checksum</span><span class="p">,</span> <span class="n">unsigned</span> <span class="n">char</span> <span class="o">*</span><span class="nb">hash</span><span class="p">);</span>
</pre></div>
</div>
<p>fdin is the input stream, that is img-&gt;fdin from the callback. The <em>hash</em>, in case of
signed images, is simply passed to copyfile() to perform the check, exactly as the <em>checksum</em>
parameter. copyfile() will return an error if checksum or hash do not match. The handler
does not need to bother with them.
How the handler manages the copied data, is specific to the handler itself. See
supplied handlers code for a better understanding.</p>
<p>The handler’s developer registers his own handler with a call to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">__attribute__</span><span class="p">((</span><span class="n">constructor</span><span class="p">))</span>
<span class="n">void</span> <span class="n">my_handler_init</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">register_handler</span><span class="p">(</span><span class="s2">&quot;mytype&quot;</span><span class="p">,</span> <span class="n">my_handler</span><span class="p">,</span> <span class="n">my_mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>SWUpdate uses the gcc constructors, and all supplied handlers are registered
when SWUpdate is initialized.</p>
<p>register_handler has the syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">register_handler</span><span class="p">(</span><span class="n">my_image_type</span><span class="p">,</span> <span class="n">my_handler</span><span class="p">,</span> <span class="n">my_mask</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>Where:</p>
<ul class="simple">
<li><p>my_image_type : string identifying the own new image type.</p></li>
<li><p>my_handler : pointer to the installer to be registered.</p></li>
<li><p>my_mask : <code class="docutils literal notranslate"><span class="pre">HANDLER_MASK</span></code> enum value(s) specifying what
input type(s) my_handler can process.</p></li>
<li><p>data : an optional pointer to an own structure, that SWUpdate
saves in the handlers’ list and pass to the handler when it will
be executed.</p></li>
</ul>
</section>
<section id="dummy-handler">
<h2>Dummy Handler<a class="headerlink" href="#dummy-handler" title="Link to this heading"></a></h2>
<p>The always built-in and aptly named dummy handler copies the artifact
to <code class="docutils literal notranslate"><span class="pre">/dev/null</span></code>, effectively skipping it and advancing to the next
artifact, if any.</p>
</section>
<section id="ubi-volume-handler">
<h2>UBI Volume Handler<a class="headerlink" href="#ubi-volume-handler" title="Link to this heading"></a></h2>
<p>The UBI volume handler will update UBI volumes without changing the
layout on the storage. Therefore, volumes must be created/adjusted
beforehand. This can be done using the <code class="docutils literal notranslate"><span class="pre">partitions</span></code> tag (see
<a class="reference internal" href="sw-description.html#partitions-ubi-layout"><span class="std std-ref">partitions : UBI layout</span></a>).</p>
<p>The UBI volume handler will search for volumes in all MTD devices
(unless blacklisted, see UBIBLACKLIST) to find the volume into which
the image shall be installed. For this reason, <strong>volume names must be
unique</strong> within the system. Two volumes with the same name are not
supported and will lead to unpredictable results (SWUpdate will
install the image to the first volume with that name it finds, which
may not be right one!).</p>
<p>When updating volumes, it is guaranteed that erase counters are
preserved and not lost. The behavior of updating is identical to that
of the <code class="docutils literal notranslate"><span class="pre">ubiupdatevol(1)</span></code> tool from mtd-utils. In fact, the same
library from mtd-utils (libubi) is reused by SWUpdate.</p>
<section id="atomic-volume-renaming">
<h3>atomic volume renaming<a class="headerlink" href="#atomic-volume-renaming" title="Link to this heading"></a></h3>
<p>The UBI volume handler has basic support for carrying out atomic
volume renames by defining the <code class="docutils literal notranslate"><span class="pre">replaces</span></code> property, which must
contain a valid UBI volume name. After successfully updating the image
to <code class="docutils literal notranslate"><span class="pre">volume</span></code>, an atomic swap of the names of <code class="docutils literal notranslate"><span class="pre">volume</span></code> and
<code class="docutils literal notranslate"><span class="pre">replaces</span></code> is done. Consider the following example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span><span class="s2">&quot;u-boot.img&quot;</span><span class="p">;</span>
        <span class="n">volume</span> <span class="o">=</span><span class="s2">&quot;u-boot_r&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">replaces</span> <span class="o">=</span> <span class="s2">&quot;u-boot&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After u-boot.img is successfully installed into the volume “u-boot_r”,
the volume “u-boot_r” is renamed to “u-boot” and “u-boot” is renamed
to “u-boot_r”.</p>
<p>This mechanism allows one to implement a simple double copy update
approach without the need of shared state with the bootloader. For
example, the U-Boot SPL can be configured to always load U-Boot from
the volume <code class="docutils literal notranslate"><span class="pre">u-boot</span></code> without the need to access the environment. The
volume replace functionality will ensure that this volume name always
points to the currently valid volume.</p>
<p>However, please note the following limitations:</p>
<ul class="simple">
<li><p>Currently the rename takes place after <em>each</em> image was installed
successfully. Hence, it only makes sense to use this feature for
images that are independent of the other installed images. A typical
example is the bootloader. This behavior may be modified in the
future to only carry out one atomic rename after all images were
installed successfully.</p></li>
<li><p>Atomic renames are only possible and permitted for volumes residing
on the same UBI device.</p></li>
</ul>
<p>There is a handler ubiswap that allow one to do an atomic swap for several
ubi volume after all the images were flashed. This handler is a script
for the point of view of SWUpdate, so the node that provide it the data
should be added in the section scripts.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ubiswap&quot;</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">swap</span><span class="o">-</span><span class="mi">0</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;boot&quot;</span> <span class="p">,</span> <span class="s2">&quot; boot_r&quot;</span> <span class="p">];</span>
                        <span class="n">swap</span><span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;kernel&quot;</span> <span class="p">,</span> <span class="s2">&quot;kernel_r&quot;</span> <span class="p">];</span>
                        <span class="n">swap</span><span class="o">-</span><span class="mi">2</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;rootfs&quot;</span> <span class="p">,</span> <span class="s2">&quot;rootfs_r&quot;</span> <span class="p">];</span>
                <span class="p">},</span>
        <span class="p">},</span>
<span class="p">);</span>
</pre></div>
</div>
<p>WARNING: if you use the property replaces on an ubi volume that is also
used with the handler ubiswap, this ubi volume will be swapped twice.
It’s probably not what you want …</p>
</section>
<section id="volume-auto-resize">
<h3>volume auto resize<a class="headerlink" href="#volume-auto-resize" title="Link to this heading"></a></h3>
<p>The UBI volume handler has support to auto resize before flashing an
image with the property <code class="docutils literal notranslate"><span class="pre">auto-resize</span></code>. When this property is set
on an image, the ubi volume is resized to fit exactly the image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;u-boot.img&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;mtd0&quot;</span><span class="p">;</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;u-boot_r&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">auto</span><span class="o">-</span><span class="n">resize</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>WARNING: when this property is used, the device must be defined.</p>
</section>
<section id="volume-always-remove">
<h3>volume always remove<a class="headerlink" href="#volume-always-remove" title="Link to this heading"></a></h3>
<p>The UBI volume handler has support to always remove ubi volume
before flashing with the property <code class="docutils literal notranslate"><span class="pre">always-remove</span></code>. When this property
is set on an image, the ubi volume is always removed. This property
should be used with property <code class="docutils literal notranslate"><span class="pre">auto-resize</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;u-boot.img&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;mtd0&quot;</span><span class="p">;</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;u-boot_r&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">always</span><span class="o">-</span><span class="n">remove</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
                <span class="n">auto</span><span class="o">-</span><span class="n">resize</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="size-properties">
<h3>size properties<a class="headerlink" href="#size-properties" title="Link to this heading"></a></h3>
<p>Due to a limit in the Linux kernel API for UBI volumes, the size reserved to be
written on disk should be declared before actually writing anything.
Unfortunately, the size of an encrypted or compressed image is not known until
the decryption or decompression finished. This prevents correct declaration of
the file size to be written on disk.</p>
<p>For this reason UBI images can declare the special properties “decrypted-size”
or “decompressed-size” like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;rootfs.ubifs.enc&quot;</span><span class="p">;</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;rootfs&quot;</span><span class="p">;</span>
                <span class="n">encrypted</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">decrypted</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;104857600&quot;</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;homefs.ubifs.gz&quot;</span><span class="p">;</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;homefs&quot;</span><span class="p">;</span>
                <span class="n">compressed</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">decompressed</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;420000000&quot;</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>The real size of the image should be calculated and written to the
sw-description before assembling the cpio archive.
In this example, 104857600 is the size of the rootfs after the decryption: the
encrypted size is by the way larger. The decompressed size is of the homefs is
420000000.</p>
<p>The sizes are bytes in decimal notation.</p>
</section>
</section>
<section id="lua-handlers">
<h2>Lua Handlers<a class="headerlink" href="#lua-handlers" title="Link to this heading"></a></h2>
<p>In addition to the handlers written in C, it is possible to extend
SWUpdate with handlers written in Lua that get loaded at SWUpdate
startup. The Lua handler source code file may either be embedded
into the SWUpdate binary via the <code class="docutils literal notranslate"><span class="pre">CONFIG_EMBEDDED_LUA_HANDLER</span></code>
config option or has to be installed on the target system in Lua’s
search path as <code class="docutils literal notranslate"><span class="pre">swupdate_handlers.lua</span></code> so that it can be loaded
by the embedded Lua interpreter at run-time.</p>
<p>In analogy to C handlers, the prototype for a Lua handler is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--- Lua Handler.
--
--- @param  image  img_type  Lua equivalent of `struct img_type`
--- @return number           # 0 on success, 1 on error
function lua_handler(image)
    ...
end
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">image</span></code> is a Lua table (with attributes according to
<a class="reference internal" href="sw-description.html#sw-description-attribute-reference"><span class="std std-ref">sw-description’s attribute reference</span></a>)
that describes a single artifact to be processed by the handler
(also see the Lua Handler Interface Specification in <code class="docutils literal notranslate"><span class="pre">handlers/swupdate.lua</span></code>,
reproduced for convenience in Section <a class="reference internal" href="#handlers-lua-specification"><span class="std std-ref">Lua Handler Interface Specification</span></a>).</p>
<p>Note that dashes in the attributes’ names are replaced with
underscores for the Lua domain to make them idiomatic, e.g.,
<code class="docutils literal notranslate"><span class="pre">installed-directly</span></code> becomes <code class="docutils literal notranslate"><span class="pre">installed_directly</span></code> in the
Lua domain.</p>
<p>For a script handler written in Lua, the prototype is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--- Lua Handler.
--
--- @param  image     img_type  Lua equivalent of `struct img_type`
--- @param  scriptfn  string    Type, one of `preinst` or `postinst`
--- @return number              # 0 on success, 1 on error
function lua_handler(image, scriptfn)
    ...
end
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">scriptfn</span></code> is either <code class="docutils literal notranslate"><span class="pre">&quot;preinst&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;postinst&quot;</span></code>.</p>
<p>To register a Lua handler, the <code class="docutils literal notranslate"><span class="pre">swupdate</span></code> module provides the
<code class="docutils literal notranslate"><span class="pre">swupdate.register_handler()</span></code> method that takes the handler’s
name, the Lua handler function to be registered under that name,
and, optionally, the types of artifacts for which the handler may
be called. If the latter is not given, the Lua handler is registered
for all types of artifacts. The following call registers the
above function <code class="docutils literal notranslate"><span class="pre">lua_handler</span></code> as <em>my_handler</em> which may be
called for images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">swupdate</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="s2">&quot;my_handler&quot;</span><span class="p">,</span> <span class="n">lua_handler</span><span class="p">,</span> <span class="n">swupdate</span><span class="o">.</span><span class="n">HANDLER_MASK</span><span class="o">.</span><span class="n">IMAGE_HANDLER</span><span class="p">)</span>
</pre></div>
</div>
<p>A Lua handler may call C handlers (“chaining”) via the
<code class="docutils literal notranslate"><span class="pre">swupdate.call_handler()</span></code> method. The callable and registered
C handlers are available (as keys) in the table
<code class="docutils literal notranslate"><span class="pre">swupdate.handler</span></code>. The following Lua code is an example of
a simple handler chain-calling the <code class="docutils literal notranslate"><span class="pre">rawfile</span></code> C handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--- Lua Handler.
--
--- @param  image  img_type  Lua equivalent of `struct img_type`
--- @return number           # 0 on success, 1 on error
function lua_handler(image)
    if not swupdate.handler[&quot;rawfile&quot;] then
        swupdate.error(&quot;rawfile handler not available&quot;)
        return 1
    end
    image.path = &quot;/tmp/destination.path&quot;
    local err, msg = swupdate.call_handler(&quot;rawfile&quot;, image)
    if err ~= 0 then
        swupdate.error(string.format(&quot;Error chaining handlers: %s&quot;, msg))
        return 1
    end
    return 0
end
</pre></div>
</div>
<p>Note that when chaining handlers and calling a C handler for
a different type of artifact than the Lua handler is registered
for, the <code class="docutils literal notranslate"><span class="pre">image</span></code> table’s values must satisfy the called
C handler’s expectations: Consider the above Lua handler being
registered for “images” (<code class="docutils literal notranslate"><span class="pre">swupdate.HANDLER_MASK.IMAGE_HANDLER</span></code>)
via the <code class="docutils literal notranslate"><span class="pre">swupdate.register_handler()</span></code> call shown above. As per the
<a class="reference internal" href="sw-description.html#sw-description-attribute-reference"><span class="std std-ref">sw-description’s attribute reference</span></a>,
the “images” artifact type doesn’t have the <code class="docutils literal notranslate"><span class="pre">path</span></code> attribute
but the “file” artifact type does. So, for calling the <code class="docutils literal notranslate"><span class="pre">rawfile</span></code>
handler, <code class="docutils literal notranslate"><span class="pre">image.path</span></code> has to be set prior to chain-calling the
<code class="docutils literal notranslate"><span class="pre">rawfile</span></code> handler, as done in the example above. Usually, however,
no such adaptation is necessary if the Lua handler is registered for
handling the type of artifact that <code class="docutils literal notranslate"><span class="pre">image</span></code> represents.</p>
<p>In addition to calling C handlers, the <code class="docutils literal notranslate"><span class="pre">image</span></code> table passed as
parameter to a Lua handler has a <code class="docutils literal notranslate"><span class="pre">image:copy2file()</span></code> method that
implements the common use case of writing the input stream’s data
to a file, which is passed as this method’s argument. On success,
<code class="docutils literal notranslate"><span class="pre">image:copy2file()</span></code> returns <code class="docutils literal notranslate"><span class="pre">0</span></code> or <code class="docutils literal notranslate"><span class="pre">-1</span></code> plus an error
message on failure. The following Lua code is an example of
a simple handler calling <code class="docutils literal notranslate"><span class="pre">image:copy2file()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--- Lua Handler.
--
--- @param  image  img_type  Lua equivalent of `struct img_type`
--- @return number           # 0 on success, 1 on error
function lua_handler(image)
    local err, msg = image:copy2file(&quot;/tmp/destination.path&quot;)
    if err ~= 0 then
        swupdate.error(string.format(&quot;Error calling copy2file: %s&quot;, msg))
        return 1
    end
    return 0
end
</pre></div>
</div>
<p>Beyond using <code class="docutils literal notranslate"><span class="pre">image:copy2file()</span></code> or chain-calling C handlers,
the <code class="docutils literal notranslate"><span class="pre">image</span></code> table passed as parameter to a Lua handler has
a <code class="docutils literal notranslate"><span class="pre">image:read(&lt;callback()&gt;)</span></code> method that reads from the input
stream and calls the Lua callback function <code class="docutils literal notranslate"><span class="pre">&lt;callback()&gt;</span></code> for
every chunk read, passing this chunk as parameter. On success,
<code class="docutils literal notranslate"><span class="pre">0</span></code> is returned by <code class="docutils literal notranslate"><span class="pre">image:read()</span></code>. On error, <code class="docutils literal notranslate"><span class="pre">-1</span></code> plus an
error message is returned. The following Lua code is an example
of a simple handler printing the artifact’s content:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>--- Lua Handler.
--
--- @param  image  img_type  Lua equivalent of `struct img_type`
--- @return number           # 0 on success, 1 on error
function lua_handler(image)
    err, msg = image:read(function(data) print(data) end)
    if err ~= 0 then
        swupdate.error(string.format(&quot;Error reading image: %s&quot;, msg))
        return 1
    end
    return 0
end
</pre></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">image:read()</span></code> method, an artifact’s contents may be
(post-)processed in and leveraging the power of Lua without relying
on preexisting C handlers for the purpose intended.</p>
<p>Just as C handlers, a Lua handler must consume the artifact
described in its <code class="docutils literal notranslate"><span class="pre">image</span></code> parameter so that SWUpdate can
continue with the next artifact in the stream after the Lua handler
returns. Chaining handlers, calling <code class="docutils literal notranslate"><span class="pre">image:copy2file()</span></code>, or using
<code class="docutils literal notranslate"><span class="pre">image:read()</span></code> satisfies this requirement.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">swupdate</span></code> Lua module interface specification that details what
functionality is made available to Lua handlers by SWUpdate’s
<code class="docutils literal notranslate"><span class="pre">corelib/lua_interface.c</span></code> is found in <code class="docutils literal notranslate"><span class="pre">handlers/swupdate.lua</span></code>.
It serves as reference, for mocking purposes, and type checking thanks
to the EmmyLua-inspired annotations.</p>
<p>Note that although the dynamic nature of Lua handlers would
technically allow one to embed them into a to be processed <code class="docutils literal notranslate"><span class="pre">.swu</span></code>
image, this is not implemented as it carries some security
implications since the behavior of SWUpdate is changed
dynamically.</p>
<section id="lua-handler-interface-specification">
<span id="handlers-lua-specification"></span><h3>Lua Handler Interface Specification<a class="headerlink" href="#lua-handler-interface-specification" title="Link to this heading"></a></h3>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span><span class="cm">--[[</span>
<span class="linenos">  2</span>
<span class="linenos">  3</span><span class="cm">    SWUpdate Lua Handler Interface.</span>
<span class="linenos">  4</span>
<span class="linenos">  5</span><span class="cm">    Interface specification for the Lua module</span>
<span class="linenos">  6</span><span class="cm">    provided by SWUpdate to Lua Handlers.</span>
<span class="linenos">  7</span><span class="cm">    See: corelib/lua_interface.c</span>
<span class="linenos">  8</span>
<span class="linenos">  9</span><span class="cm">    Copyright (C) 2022, Siemens AG</span>
<span class="linenos"> 10</span><span class="cm">    Author: Christian Storm &lt;christian.storm@siemens.com&gt;</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span><span class="cm">    SPDX-License-Identifier: GPL-2.0-or-later</span>
<span class="linenos"> 13</span>
<span class="linenos"> 14</span><span class="cm">--]]</span>
<span class="linenos"> 15</span>
<span class="linenos"> 16</span><span class="c1">---@diagnostic disable: missing-return</span>
<span class="linenos"> 17</span><span class="c1">---@diagnostic disable: unused-local</span>
<span class="linenos"> 18</span><span class="c1">-- luacheck: no unused args</span>
<span class="linenos"> 19</span>
<span class="linenos"> 20</span>
<span class="linenos"> 21</span><span class="c1">--- SWUpdate Lua Handler Module.</span>
<span class="linenos"> 22</span><span class="c1">--- @class swupdate</span>
<span class="linenos"> 23</span><span class="kd">local</span> <span class="n">swupdate</span> <span class="o">=</span> <span class="p">{}</span>
<span class="linenos"> 24</span>
<span class="linenos"> 25</span>
<span class="linenos"> 26</span><span class="c1">--- @enum swupdate.RECOVERY_STATUS</span>
<span class="linenos"> 27</span><span class="c1">--- Lua equivalent of `RECOVERY_STATUS` as in `include/swupdate_status.h`.</span>
<span class="linenos"> 28</span><span class="n">swupdate</span><span class="p">.</span><span class="n">RECOVERY_STATUS</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos"> 29</span>    <span class="n">IDLE</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos"> 30</span>    <span class="n">START</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos"> 31</span>    <span class="n">RUN</span>        <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos"> 32</span>    <span class="n">SUCCESS</span>    <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="linenos"> 33</span>    <span class="n">FAILURE</span>    <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos"> 34</span>    <span class="n">DOWNLOAD</span>   <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="linenos"> 35</span>    <span class="n">DONE</span>       <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
<span class="linenos"> 36</span>    <span class="n">SUBPROCESS</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="linenos"> 37</span>    <span class="n">PROGRESS</span>   <span class="o">=</span> <span class="mi">8</span>
<span class="linenos"> 38</span><span class="p">}</span>
<span class="linenos"> 39</span>
<span class="linenos"> 40</span><span class="c1">--- Lua equivalent of `ERROR(format, ...)`.</span>
<span class="linenos"> 41</span><span class="c1">--- @param format  string  Format string</span>
<span class="linenos"> 42</span><span class="c1">--- @param ...     any     Varargs as referenced in format string</span>
<span class="linenos"> 43</span><span class="n">swupdate</span><span class="p">.</span><span class="n">error</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span>
<span class="linenos"> 44</span>
<span class="linenos"> 45</span><span class="c1">--- Lua equivalent of `TRACE(format, ...)`.</span>
<span class="linenos"> 46</span><span class="c1">--- @param format  string  Format string</span>
<span class="linenos"> 47</span><span class="c1">--- @param ...     any     Varargs as referenced in format string</span>
<span class="linenos"> 48</span><span class="n">swupdate</span><span class="p">.</span><span class="n">trace</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span>
<span class="linenos"> 49</span>
<span class="linenos"> 50</span><span class="c1">--- Lua equivalent of `INFO(format, ...)`.</span>
<span class="linenos"> 51</span><span class="c1">--- @param format  string  Format string</span>
<span class="linenos"> 52</span><span class="c1">--- @param ...     any     Varargs as referenced in format string</span>
<span class="linenos"> 53</span><span class="n">swupdate</span><span class="p">.</span><span class="n">info</span>  <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span>
<span class="linenos"> 54</span>
<span class="linenos"> 55</span><span class="c1">--- Lua equivalent of `WARN(format, ...)`.</span>
<span class="linenos"> 56</span><span class="c1">--- @param format  string  Format string</span>
<span class="linenos"> 57</span><span class="c1">--- @param ...     any     Varargs as referenced in format string</span>
<span class="linenos"> 58</span><span class="n">swupdate</span><span class="p">.</span><span class="n">warn</span>  <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span>
<span class="linenos"> 59</span>
<span class="linenos"> 60</span><span class="c1">--- Lua equivalent of `DEBUG(format, ...)`.</span>
<span class="linenos"> 61</span><span class="c1">--- @param format  string  Format string</span>
<span class="linenos"> 62</span><span class="c1">--- @param ...     any     Varargs as referenced in format string</span>
<span class="linenos"> 63</span><span class="n">swupdate</span><span class="p">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="p">...)</span> <span class="kr">end</span>
<span class="linenos"> 64</span>
<span class="linenos"> 65</span><span class="c1">--- Lua equivalent of `notify(PROGRESS, ..., msg)`.</span>
<span class="linenos"> 66</span><span class="c1">--- @param msg    string        Message to send to progress interface</span>
<span class="linenos"> 67</span><span class="c1">--- @param cause  number | nil  `progress_cause_t` value as defined in `include/progress_ipc.h`</span>
<span class="linenos"> 68</span><span class="n">swupdate</span><span class="p">.</span><span class="n">progress</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">cause</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos"> 69</span>
<span class="linenos"> 70</span><span class="c1">--- Lua equivalent of `notify(status, error, INFOLEVEL, msg)`.</span>
<span class="linenos"> 71</span><span class="c1">--- @param status  swupdate.RECOVERY_STATUS  Current status, one of `swupdate.RECOVERY_STATUS`&#39;s values</span>
<span class="linenos"> 72</span><span class="c1">--- @param error   number                    Error code</span>
<span class="linenos"> 73</span><span class="c1">--- @param msg     string                    Message</span>
<span class="linenos"> 74</span><span class="n">swupdate</span><span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="nb">error</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos"> 75</span>
<span class="linenos"> 76</span>
<span class="linenos"> 77</span><span class="c1">--- Report whether dry-run installation is performed.</span>
<span class="linenos"> 78</span><span class="c1">--</span>
<span class="linenos"> 79</span><span class="c1">--- @return boolean  # `true` if dry-run installation is performed, `false` otherwise</span>
<span class="linenos"> 80</span><span class="n">swupdate</span><span class="p">.</span><span class="n">is_dryrun</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos"> 81</span>
<span class="linenos"> 82</span>
<span class="linenos"> 83</span><span class="c1">--- Update progress.</span>
<span class="linenos"> 84</span><span class="c1">--</span>
<span class="linenos"> 85</span><span class="c1">--- @param percent  number  Progress percent to set</span>
<span class="linenos"> 86</span><span class="n">swupdate</span><span class="p">.</span><span class="n">progress_update</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos"> 87</span>
<span class="linenos"> 88</span>
<span class="linenos"> 89</span><span class="c1">--- Mount a filesystem to a temporary mountpoint.</span>
<span class="linenos"> 90</span><span class="c1">--</span>
<span class="linenos"> 91</span><span class="c1">--- @param  device      string  Device to mount</span>
<span class="linenos"> 92</span><span class="c1">--- @param  filesystem  string  Device&#39;s filesystem</span>
<span class="linenos"> 93</span><span class="c1">--- @return string | nil        # Mountpoint for use with `swupdate.umount(target)`, `nil` on error</span>
<span class="linenos"> 94</span><span class="n">swupdate</span><span class="p">.</span><span class="n">mount</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">filesystem</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos"> 95</span>
<span class="linenos"> 96</span><span class="c1">--- Unmount a mountpoint returned by `swupdate.mount()`.</span>
<span class="linenos"> 97</span><span class="c1">--</span>
<span class="linenos"> 98</span><span class="c1">--- @param  target  string  Mountpoint to unmount</span>
<span class="linenos"> 99</span><span class="c1">--- @return boolean | nil   # `true` if successful, `nil` on error</span>
<span class="linenos">100</span><span class="n">swupdate</span><span class="p">.</span><span class="n">umount</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">101</span>
<span class="linenos">102</span>
<span class="linenos">103</span><span class="c1">--- @enum swupdate.ROOT_DEVICE</span>
<span class="linenos">104</span><span class="c1">--- Lua equivalent of `root_dev_type` as in `include/lua_util.h`.</span>
<span class="linenos">105</span><span class="n">swupdate</span><span class="p">.</span><span class="n">ROOT_DEVICE</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">106</span>    <span class="n">PATH</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="linenos">107</span>    <span class="n">UUID</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">108</span>    <span class="n">PARTUUID</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">109</span>    <span class="n">PARTLABEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="linenos">110</span><span class="p">}</span>
<span class="linenos">111</span>
<span class="linenos">112</span>
<span class="linenos">113</span><span class="c1">--- Current root device information.</span>
<span class="linenos">114</span><span class="c1">--- @class swupdate.rootdev</span>
<span class="linenos">115</span><span class="c1">--- @field type   swupdate.ROOT_DEVICE  Root device type, one of `swupdate.ROOT_DEVICE`&#39;s values</span>
<span class="linenos">116</span><span class="c1">--- @field value  string                Root device path</span>
<span class="linenos">117</span><span class="c1">--- @field path   string                Full root device path, if identified, else nil</span>
<span class="linenos">118</span>
<span class="linenos">119</span><span class="c1">--- Get current root device.</span>
<span class="linenos">120</span><span class="c1">--</span>
<span class="linenos">121</span><span class="c1">--- @return swupdate.rootdev  # Table containing type, and (full) path to root device</span>
<span class="linenos">122</span><span class="n">swupdate</span><span class="p">.</span><span class="n">getroot</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">123</span>
<span class="linenos">124</span><span class="c1">--- Get the HW boot device of an eMMC.</span>
<span class="linenos">125</span><span class="c1">--</span>
<span class="linenos">126</span><span class="c1">--- @param devicepath  string  Fully qualified device path</span>
<span class="linenos">127</span><span class="c1">--- @return integer            # eMMC boot device number or `-1` on error</span>
<span class="linenos">128</span><span class="n">swupdate</span><span class="p">.</span><span class="n">emmcbootpart</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">devicepath</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">129</span>
<span class="linenos">130</span>
<span class="linenos">131</span><span class="c1">--- Table with major/minor numbers of the device on which the swupdate.stat()&#39;d file resides.</span>
<span class="linenos">132</span><span class="c1">--- @class swupdate.stat_dev</span>
<span class="linenos">133</span><span class="c1">--- @field major  number  Major device number</span>
<span class="linenos">134</span><span class="c1">--- @field minor  number  Minor device number</span>
<span class="linenos">135</span>
<span class="linenos">136</span><span class="c1">--- `struct stat`-alike Table.</span>
<span class="linenos">137</span><span class="c1">--- @class swupdate.stat_info</span>
<span class="linenos">138</span><span class="c1">--- @field mode          &quot;directory&quot;|&quot;named pipe&quot;|&quot;link&quot;|&quot;regular file&quot;|&quot;socket&quot;|&quot;block device&quot;|&quot;char device&quot;|&quot;unknown&quot;  File type and mode</span>
<span class="linenos">139</span><span class="c1">--- @field dev           swupdate.stat_dev  ID of device containing file</span>
<span class="linenos">140</span><span class="c1">--- @field ino           number             Inode number</span>
<span class="linenos">141</span><span class="c1">--- @field nlink         number             Number of hard links</span>
<span class="linenos">142</span><span class="c1">--- @field uid           number             User ID of owner</span>
<span class="linenos">143</span><span class="c1">--- @field gid           number             Group ID of owner</span>
<span class="linenos">144</span><span class="c1">--- @field rdev          swupdate.stat_dev  Device ID (if special file)</span>
<span class="linenos">145</span><span class="c1">--- @field access        string             Time of last access, e.g., &quot;Wed Jun 30 21:49:08 1993&quot;</span>
<span class="linenos">146</span><span class="c1">--- @field modification  string             Time of last modification, e.g., &quot;Wed Jun 30 21:49:08 1993&quot;</span>
<span class="linenos">147</span><span class="c1">--- @field change        string             Time of last status change, e.g., &quot;Wed Jun 30 21:49:08 1993&quot;</span>
<span class="linenos">148</span><span class="c1">--- @field size          number             Total size, in bytes</span>
<span class="linenos">149</span><span class="c1">--- @field permissions   string             Unix file permissions string, e.g., &quot;rwxr-xr-x&quot;</span>
<span class="linenos">150</span><span class="c1">--- @field blocks        number             Number of 512B blocks allocated</span>
<span class="linenos">151</span><span class="c1">--- @field blksize       number             Block size for filesystem I/O</span>
<span class="linenos">152</span>
<span class="linenos">153</span><span class="c1">--- STAT(2) Wrapper.</span>
<span class="linenos">154</span><span class="c1">--</span>
<span class="linenos">155</span><span class="c1">--- @param  pathname  string          Retrieve information about the file `pathname`</span>
<span class="linenos">156</span><span class="c1">--- @return swupdate.stat_info | nil  # `struct stat`-alike Table if successful, nil on error</span>
<span class="linenos">157</span><span class="n">swupdate</span><span class="p">.</span><span class="n">stat</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">158</span>
<span class="linenos">159</span>
<span class="linenos">160</span><span class="c1">--- Get SWUpdate&#39;s TMPDIRSCRIPT directory.</span>
<span class="linenos">161</span><span class="c1">--</span>
<span class="linenos">162</span><span class="c1">--- @return string  # TMPDIRSCRIPT directory</span>
<span class="linenos">163</span><span class="n">swupdate</span><span class="p">.</span><span class="n">tmpdirscripts</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">164</span>
<span class="linenos">165</span><span class="c1">--- Get SWUpdate&#39;s TMPDIR directory.</span>
<span class="linenos">166</span><span class="c1">--</span>
<span class="linenos">167</span><span class="c1">--- @return string  # TMPDIR directory</span>
<span class="linenos">168</span><span class="n">swupdate</span><span class="p">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">169</span>
<span class="linenos">170</span>
<span class="linenos">171</span><span class="c1">--- SWUpdate hardware information.</span>
<span class="linenos">172</span><span class="c1">--- @class swupdate.hardware</span>
<span class="linenos">173</span><span class="c1">--- @field boardname   string  SWUpdate&#39;s boardname</span>
<span class="linenos">174</span><span class="c1">--- @field revision    string  SWUpdate&#39;s revision</span>
<span class="linenos">175</span>
<span class="linenos">176</span><span class="c1">--- Get SWUpdate hardware.</span>
<span class="linenos">177</span><span class="c1">--</span>
<span class="linenos">178</span><span class="c1">--- @return swupdate.hardware  # Table with &#39;boardname&#39; and &#39;revision&#39; fields</span>
<span class="linenos">179</span><span class="n">swupdate</span><span class="p">.</span><span class="n">get_hw</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">180</span>
<span class="linenos">181</span>
<span class="linenos">182</span><span class="c1">--- SWUpdate version information.</span>
<span class="linenos">183</span><span class="c1">--- @class swupdate.version</span>
<span class="linenos">184</span><span class="c1">--- @field [1]         number  SWUpdate&#39;s version</span>
<span class="linenos">185</span><span class="c1">--- @field [2]         number  SWUpdate&#39;s patch level</span>
<span class="linenos">186</span><span class="c1">--- @field version     number  SWUpdate&#39;s version</span>
<span class="linenos">187</span><span class="c1">--- @field patchlevel  number  SWUpdate&#39;s patch level</span>
<span class="linenos">188</span>
<span class="linenos">189</span><span class="c1">--- Get SWUpdate version.</span>
<span class="linenos">190</span><span class="c1">--</span>
<span class="linenos">191</span><span class="c1">--- @return swupdate.version  # Table with &#39;version&#39; and &#39;patchlevel&#39; fields</span>
<span class="linenos">192</span><span class="n">swupdate</span><span class="p">.</span><span class="n">getversion</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">193</span>
<span class="linenos">194</span>
<span class="linenos">195</span><span class="c1">--- Get software Selection and Mode.</span>
<span class="linenos">196</span><span class="c1">--</span>
<span class="linenos">197</span><span class="c1">--- @return string  # Selection</span>
<span class="linenos">198</span><span class="c1">--- @return string  # Mode</span>
<span class="linenos">199</span><span class="n">swupdate</span><span class="p">.</span><span class="n">get_selection</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">200</span>
<span class="linenos">201</span><span class="c1">--- Get Linux Command Line Parameters</span>
<span class="linenos">202</span><span class="c1">--</span>
<span class="linenos">203</span><span class="c1">--- @return table  # Table with keys and values fields</span>
<span class="linenos">204</span><span class="n">swupdate</span><span class="p">.</span><span class="n">get_cmdline</span> <span class="o">=</span> <span class="kr">function</span><span class="p">()</span> <span class="kr">end</span>
<span class="linenos">205</span>
<span class="linenos">206</span><span class="c1">--- Set Bootloader environment key=value.</span>
<span class="linenos">207</span><span class="c1">--</span>
<span class="linenos">208</span><span class="c1">--- @param key    string  Bootloader environment key to set</span>
<span class="linenos">209</span><span class="c1">--- @param value  string  Value to set `key` to in bootloader environment</span>
<span class="linenos">210</span><span class="n">swupdate</span><span class="p">.</span><span class="n">set_bootenv</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">211</span>
<span class="linenos">212</span><span class="c1">--- Get Bootloader environment key&#39;s value.</span>
<span class="linenos">213</span><span class="c1">--</span>
<span class="linenos">214</span><span class="c1">--- @param  key  string  Bootloader environment&#39;s key to get value from</span>
<span class="linenos">215</span><span class="c1">--- @return string       # Bootloader environment key&#39;s value, empty if key absent</span>
<span class="linenos">216</span><span class="n">swupdate</span><span class="p">.</span><span class="n">get_bootenv</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">217</span>
<span class="linenos">218</span>
<span class="linenos">219</span><span class="c1">--- @enum swupdate.HANDLER_MASK</span>
<span class="linenos">220</span><span class="c1">--- Lua equivalent of `HANDLER_MASK` as in `include/handler.h`.</span>
<span class="linenos">221</span><span class="n">swupdate</span><span class="p">.</span><span class="n">HANDLER_MASK</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">222</span>    <span class="n">IMAGE_HANDLER</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">223</span>    <span class="n">FILE_HANDLER</span>       <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="linenos">224</span>    <span class="n">SCRIPT_HANDLER</span>     <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="linenos">225</span>    <span class="n">BOOTLOADER_HANDLER</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
<span class="linenos">226</span>    <span class="n">PARTITION_HANDLER</span>  <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
<span class="linenos">227</span>    <span class="n">NO_DATA_HANDLER</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
<span class="linenos">228</span>    <span class="n">ANY_HANDLER</span>        <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">+</span> <span class="mi">32</span>
<span class="linenos">229</span><span class="p">}</span>
<span class="linenos">230</span>
<span class="linenos">231</span><span class="c1">--- Register a Lua function as Handler implementation.</span>
<span class="linenos">232</span><span class="c1">--</span>
<span class="linenos">233</span><span class="c1">-- The signature of the function to be registered as Handler implementation is:</span>
<span class="linenos">234</span><span class="c1">--</span>
<span class="linenos">235</span><span class="c1">-- --- @param  image     img_type  Lua equivalent of `struct img_type`</span>
<span class="linenos">236</span><span class="c1">-- --- @param  fn | nil  string    `preinst` or `postinst` for `SCRIPT_HANDLER`s, else nil</span>
<span class="linenos">237</span><span class="c1">-- --- @return number    # 0 on success, 1 on error</span>
<span class="linenos">238</span><span class="c1">-- function lua_handler(image, fn)</span>
<span class="linenos">239</span><span class="c1">--     ...</span>
<span class="linenos">240</span><span class="c1">-- end</span>
<span class="linenos">241</span><span class="c1">--</span>
<span class="linenos">242</span><span class="c1">--- @param name     string    Registered Handler&#39;s name</span>
<span class="linenos">243</span><span class="c1">--- @param funcptr  function  Function to register as Handler implementation</span>
<span class="linenos">244</span><span class="c1">--- @param mask     number    Type(s) for which to register the Handler, one or more ORed values of `swupdate.HANDLER_MASK`</span>
<span class="linenos">245</span><span class="n">swupdate</span><span class="p">.</span><span class="n">register_handler</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">funcptr</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">246</span>
<span class="linenos">247</span>
<span class="linenos">248</span><span class="c1">--- Lua equivalent of `struct img_type {...}` as in `include/swupdate.h` plus `read()` and `copy2file()` functions.</span>
<span class="linenos">249</span><span class="c1">--- @class img_type</span>
<span class="linenos">250</span><span class="c1">--- @field name                  string    `sw-component` name to check with `sw-versions`</span>
<span class="linenos">251</span><span class="c1">--- @field version               string    `sw-component` version to check with `sw-versions`</span>
<span class="linenos">252</span><span class="c1">--- @field filename              string    File name in CPIO archive</span>
<span class="linenos">253</span><span class="c1">--- @field volume                string    If handler is &quot;ubivol&quot;, the UBI volume name</span>
<span class="linenos">254</span><span class="c1">--- @field type                  string    The Handler name</span>
<span class="linenos">255</span><span class="c1">--- @field device                string    Device node to operate on for mounting, flashing, ...</span>
<span class="linenos">256</span><span class="c1">--- @field path                  string    For FILE_HANDLERs: the relative destination path</span>
<span class="linenos">257</span><span class="c1">--- @field mtdname               string    MTD device where image must be installed</span>
<span class="linenos">258</span><span class="c1">--- @field data                  string    Handler-specific arbitrary data</span>
<span class="linenos">259</span><span class="c1">--- @field filesystem            string    For FILE_HANDLERs: the filesystem to mount</span>
<span class="linenos">260</span><span class="c1">--- @field ivt                   string    IVT of an encrypted artifact</span>
<span class="linenos">261</span><span class="c1">--- @field installed_directly    boolean   Whether to stream image to `device` w/o temporary copy</span>
<span class="linenos">262</span><span class="c1">--- @field install_if_different  boolean   Whether to compare `name` and `version` accordingly</span>
<span class="linenos">263</span><span class="c1">--- @field install_if_higher     boolean   Whether to compare `name` and `version` accordingly</span>
<span class="linenos">264</span><span class="c1">--- @field encrypted             boolean   Whether the artifact is encrypted</span>
<span class="linenos">265</span><span class="c1">--- @field partition             boolean   Whether the artifact is a partitioner</span>
<span class="linenos">266</span><span class="c1">--- @field script                boolean   Whether the artifact is a script</span>
<span class="linenos">267</span><span class="c1">--- @field preserve_attributes   boolean   Whether to preserve attributes in archives</span>
<span class="linenos">268</span><span class="c1">--- @field offset                number    Offset to seek to in artifact</span>
<span class="linenos">269</span><span class="c1">--- @field size                  number    Artifact size</span>
<span class="linenos">270</span><span class="c1">--- @field checksum              number    Computed checksum</span>
<span class="linenos">271</span><span class="c1">--- @field skip                  number    `skip_t` enum number as in `include/swupdate.h`</span>
<span class="linenos">272</span><span class="c1">--- @field compressed            string    `zlib` or `zstd` (boolean value is deprecated)</span>
<span class="linenos">273</span><span class="c1">--- @field properties            table     Properties Table equivalent as specified in `sw-description`</span>
<span class="linenos">274</span><span class="c1">--- @field sha256                string    sha256 hash of the image, file, or script</span>
<span class="linenos">275</span><span class="kd">local</span> <span class="n">img_type</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">276</span>    <span class="c1">--- Store the current image artifact to disk.</span>
<span class="linenos">277</span>    <span class="c1">--</span>
<span class="linenos">278</span>    <span class="c1">--- @param  self  img_type  This `img_type` instance</span>
<span class="linenos">279</span>    <span class="c1">--- @param  path  string    Path to store the current image artifact to</span>
<span class="linenos">280</span>    <span class="c1">--- @return number          # 0 on success, -1 on error</span>
<span class="linenos">281</span>    <span class="c1">--- @return string | nil    # nil on success, error message on failure</span>
<span class="linenos">282</span>    <span class="p">[</span><span class="s1">&#39;copy2file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos">283</span>
<span class="linenos">284</span>    <span class="c1">--- Process the current image artifact in Lua.</span>
<span class="linenos">285</span>    <span class="c1">--</span>
<span class="linenos">286</span>    <span class="c1">-- The `callback = function(chunk) ... end` is repeatedly called with</span>
<span class="linenos">287</span>    <span class="c1">-- chunked artifact data of type `string` in its `chunk` parameter as</span>
<span class="linenos">288</span>    <span class="c1">-- long as there is data available.</span>
<span class="linenos">289</span>    <span class="c1">-- The callback function must completely consume the artifact data so</span>
<span class="linenos">290</span>    <span class="c1">-- that SWUpdate can continue with the stream&#39;s next artifact after</span>
<span class="linenos">291</span>    <span class="c1">-- the Lua Handler returns.</span>
<span class="linenos">292</span>    <span class="c1">--</span>
<span class="linenos">293</span>    <span class="c1">--- @param  self      img_type  This `img_type` instance</span>
<span class="linenos">294</span>    <span class="c1">--- @param  callback  function  Callback `function(chunk) ... end` that is fed the current image artifact in chunks.</span>
<span class="linenos">295</span>    <span class="c1">--- @return number              # 0 on success, -1 on error</span>
<span class="linenos">296</span>    <span class="c1">--- @return string | nil        # nil on success, error message on failure</span>
<span class="linenos">297</span>    <span class="p">[</span><span class="s1">&#39;read&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span> <span class="kr">end</span><span class="p">,</span>
<span class="linenos">298</span><span class="p">}</span>
<span class="linenos">299</span>
<span class="linenos">300</span>
<span class="linenos">301</span><span class="c1">--- @class swupdate.handler</span>
<span class="linenos">302</span><span class="c1">--- Chain-callable SWUpdate Handlers (Non-exhaustive).</span>
<span class="linenos">303</span><span class="c1">--</span>
<span class="linenos">304</span><span class="c1">-- Note: This list of built-in Handlers is non-exhaustive and</span>
<span class="linenos">305</span><span class="c1">-- purely illustrative. At run-time, SWUpdate populates this</span>
<span class="linenos">306</span><span class="c1">-- Table with the actually available Handlers according to its</span>
<span class="linenos">307</span><span class="c1">-- compile-time configuration and Lua Handlers loaded.</span>
<span class="linenos">308</span><span class="c1">--</span>
<span class="linenos">309</span><span class="c1">--- @type table&lt;string, number&gt;</span>
<span class="linenos">310</span><span class="n">swupdate</span><span class="p">.</span><span class="n">handler</span> <span class="o">=</span> <span class="p">{</span>
<span class="linenos">311</span>    <span class="c1">--- Archive Handler (See: `handlers/archive_handler.c`).</span>
<span class="linenos">312</span>    <span class="p">[</span><span class="s2">&quot;archive&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">313</span>    <span class="c1">--- `tar` Archive Handler (See: `handlers/archive_handler.c`).</span>
<span class="linenos">314</span>    <span class="p">[</span><span class="s2">&quot;tar&quot;</span><span class="p">]</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">315</span>    <span class="c1">--- Bootloader Handler (See: `handlers/boot_handler.c`).</span>
<span class="linenos">316</span>    <span class="p">[</span><span class="s2">&quot;bootloader&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">317</span>    <span class="c1">--- &quot;dummy&quot; Handler (See: `handlers/dummy_handler.c`).</span>
<span class="linenos">318</span>    <span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">319</span>    <span class="c1">--- Delta Handler (See: `handlers/delta_handler.c`).</span>
<span class="linenos">320</span>    <span class="p">[</span><span class="s2">&quot;delta&quot;</span><span class="p">]</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">321</span>    <span class="c1">--- Disk Format Handler (See: `handlers/diskformat_handler.c`).</span>
<span class="linenos">322</span>    <span class="p">[</span><span class="s2">&quot;diskformat&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">323</span>    <span class="c1">--- Disk Partition Handler (See: `handlers/diskpart_handler.c`).</span>
<span class="linenos">324</span>    <span class="p">[</span><span class="s2">&quot;diskpart&quot;</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">325</span>    <span class="c1">--- Toggle Boot Flag Handler (See: `handlers/diskpart_handler.c`).</span>
<span class="linenos">326</span>    <span class="p">[</span><span class="s2">&quot;toggleboot&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">327</span>    <span class="c1">--- Flash Hamming1 Handler (See: `handlers/flash_hamming1_handler.c`).</span>
<span class="linenos">328</span>    <span class="p">[</span><span class="s2">&quot;flash-hamming1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">329</span>    <span class="c1">--- Flash Handler (See: `handlers/flash_handler.c`).</span>
<span class="linenos">330</span>    <span class="p">[</span><span class="s2">&quot;flash&quot;</span><span class="p">]</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">331</span>    <span class="c1">--- Raw Image Handler (See: `handlers/raw_handler.c`).</span>
<span class="linenos">332</span>    <span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">333</span>    <span class="c1">--- Raw File Handler (See: `handlers/raw_handler.c`).</span>
<span class="linenos">334</span>    <span class="p">[</span><span class="s2">&quot;rawfile&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">335</span>    <span class="c1">--- Raw Copy Handler (See: `handlers/raw_handler.c`).</span>
<span class="linenos">336</span>    <span class="p">[</span><span class="s2">&quot;rawcopy&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">337</span>    <span class="c1">--- rdiff Image Handler (See: `handlers/rdiff_handler.c`).</span>
<span class="linenos">338</span>    <span class="p">[</span><span class="s2">&quot;rdiff_image&quot;</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">339</span>    <span class="c1">--- rdiff File Handler (See: `handlers/rdiff_handler.c`).</span>
<span class="linenos">340</span>    <span class="p">[</span><span class="s2">&quot;rdiff_file&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">341</span>    <span class="c1">--- Readback Handler (See: `handlers/readback_handler.c`).</span>
<span class="linenos">342</span>    <span class="p">[</span><span class="s2">&quot;readback&quot;</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">343</span>    <span class="c1">--- Remote Handler (See: `handlers/remote_handler.c`).</span>
<span class="linenos">344</span>    <span class="p">[</span><span class="s2">&quot;remote&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">345</span>    <span class="c1">--- SSBL Handler (See: `handlers/ssbl_handler.c`).</span>
<span class="linenos">346</span>    <span class="p">[</span><span class="s2">&quot;ssblswitch&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">347</span>    <span class="c1">--- SWU Forward Handler (See: `handlers/swuforward_handler.c`).</span>
<span class="linenos">348</span>    <span class="p">[</span><span class="s2">&quot;swuforward&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">349</span>    <span class="c1">--- UBI Volume Handler (See: `handlers/ubivol_handler.c`).</span>
<span class="linenos">350</span>    <span class="p">[</span><span class="s2">&quot;ubivol&quot;</span><span class="p">]</span>         <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">351</span>    <span class="c1">--- UBI Partition Handler (See: `handlers/ubivol_handler.c`).</span>
<span class="linenos">352</span>    <span class="p">[</span><span class="s2">&quot;ubipartition&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">353</span>    <span class="c1">--- UBI Swap Handler (See: `handlers/ubivol_handler.c`).</span>
<span class="linenos">354</span>    <span class="p">[</span><span class="s2">&quot;ubiswap&quot;</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">355</span>    <span class="c1">--- ucfw Handler (See: `handlers/ucfw_handler.c`).</span>
<span class="linenos">356</span>    <span class="p">[</span><span class="s2">&quot;ucfw&quot;</span><span class="p">]</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">357</span>    <span class="c1">--- Unique UUID Handler (See: `handlers/uniqueuuid_handler.c`).</span>
<span class="linenos">358</span>    <span class="p">[</span><span class="s2">&quot;uniqueuuid&quot;</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="linenos">359</span><span class="p">}</span>
<span class="linenos">360</span>
<span class="linenos">361</span><span class="c1">--- Chain-call another Handler.</span>
<span class="linenos">362</span><span class="c1">--</span>
<span class="linenos">363</span><span class="c1">--- @param  handler  string    Chain-called Handler&#39;s name</span>
<span class="linenos">364</span><span class="c1">--- @param  image    img_type  Lua equivalent of `struct img_type` as in `include/swupdate.h`</span>
<span class="linenos">365</span><span class="c1">--- @return number             # 0 on success, 1 on failure</span>
<span class="linenos">366</span><span class="c1">--- @return string | nil       # nil on success, error message on failure</span>
<span class="linenos">367</span><span class="n">swupdate</span><span class="p">.</span><span class="n">call_handler</span> <span class="o">=</span> <span class="kr">function</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span> <span class="kr">end</span>
<span class="linenos">368</span>
<span class="linenos">369</span>
<span class="linenos">370</span><span class="kr">return</span> <span class="n">swupdate</span>
</pre></div>
</div>
</section>
</section>
<section id="shell-script-handler">
<h2>Shell script handler<a class="headerlink" href="#shell-script-handler" title="Link to this heading"></a></h2>
<p>This handler allows to run a shell script that is packed into the SWU. Please note
that running a shell script opens a set of different security issues. Shell scripts
are supported due to their large acceptance, but you should prefer Lua Scripts.</p>
<p>SWUpdate will run the binary shell “/bin/sh” to execute the script.</p>
</section>
<section id="lua-script-handler">
<h2>Lua script handler<a class="headerlink" href="#lua-script-handler" title="Link to this heading"></a></h2>
<p>A Lua Script handler runs a script in Lua language. There are two possible ways to run the
script:</p>
<blockquote>
<div><ul class="simple">
<li><p>local: the script runs in own (isolated) Lua state that is created for the script.
The script has access only to function defined inside the script or functions
provided by external libraries, like the internal SWUpdate library called via
“require(swupdate)”.</p></li>
<li><p>global: SWUpdate create a Lua state at the beginning of an Update and this is
valid until the update is terminated. In this case, the script has access to any function
and structure that was defined during the update. For example, a function
can be defined inside sw-description, and the script can call it.</p></li>
</ul>
</div></blockquote>
<p>As default, each script runs in isolated / local Lua state. If the property “global-state” is set,
then the common Lua state used for each Update transaction is taken.</p>
<p>Scripts ran in isolated context in previous versions. SWUpdate allocates a new
Lua state, and import the basic libraries before loading the script. A
script is then isolated, but it cannot access to function already
loaded, or it is not possible to reuse functions from 2 or more scripts.</p>
<p>With the introduction of a per installation Lua state, Lua scripts can
call functions already defined in previous scripts, or defined in
sw-description. Because when a script is loaded, existing functions with the same name are overwritten,
it was decided that functions in scripts must be unique, that is each function should be declared just
once during an installation process.</p>
<p>This means that for global state, sw-description should contain the name of the function for each step
(pre- , postinstall or postfailure) that should be called: the names preinst, postinst and postfailure are
still valid in case the script runs with isolated state.</p>
<p>This allows also to load a script without executing if no functions are defined, and functions in the script
can be called by later scripts.</p>
<p>Note that the handler will load the script in case of global state just once during the “preinstall” call.
Later, it is assumed that functions will be already available.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;testscript.lua&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;lua&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="k">global</span><span class="o">-</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
            <span class="n">preinstall</span> <span class="o">=</span> <span class="s2">&quot;pretest1&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;test2script.lua&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;lua&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="k">global</span><span class="o">-</span><span class="n">state</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
            <span class="n">postinstall</span> <span class="o">=</span> <span class="s2">&quot;posttest2&quot;</span><span class="p">;</span>
            <span class="n">postfailure</span> <span class="o">=</span> <span class="s2">&quot;failure&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Two scripts are defined. Both are using the global Lua state.
Functions in test2script can find and run functions defined in testscript.lua,
because both are belonging to the same context. When preinstall scripts are called, only the function
“pretest1” from the first script is called, because no function name is defined for this step with
the following scripts.</p>
</section>
<section id="remote-handler">
<h2>Remote handler<a class="headerlink" href="#remote-handler" title="Link to this heading"></a></h2>
<p>Remote handlers are thought for binding legacy installers
without having the necessity to rewrite them in Lua. The remote
handler forward the image to be installed to another process,
waiting for an acknowledge to be sure that the image is installed
correctly.
The remote handler makes use of the zeromq library - this is
to simplify the IPC with Unix Domain Socket. The remote handler
is quite general, describing in sw-description with the
“data” attribute how to communicate with the external process.
The remote handler always acts as client, and try a connect()
using the socket identified by the “data” attribute. For example,
a possible setup using a remote handler could be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;myimage&quot;&quot;;</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;remote&quot;</span><span class="p">;</span>
            <span class="n">data</span> <span class="o">=</span> <span class="s2">&quot;test_remote&quot;</span><span class="p">;</span>
         <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The connection is instantiated using the socket <code class="docutils literal notranslate"><span class="pre">test_remote</span></code> (according
to the “data” field’s value) in the directory pointed to by the environment
variable <code class="docutils literal notranslate"><span class="pre">TMPDIR</span></code> with <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> as fall-back if <code class="docutils literal notranslate"><span class="pre">TMPDIR</span></code> is not set.
If <code class="docutils literal notranslate"><span class="pre">connect()</span></code> fails, the  remote handler signals that the update is not
successful. Each zeromq message  from SWUpdate is a multi-part message split
into two frames:</p>
<blockquote>
<div><ul class="simple">
<li><p>first frame contains a string with a command.</p></li>
<li><p>second frame contains data and can be of 0 bytes.</p></li>
</ul>
</div></blockquote>
<p>There are currently just two possible commands: INIT and DATA. After
a successful connect, SWUpdate sends the initialization string in the
format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INIT</span><span class="p">:</span><span class="o">&lt;</span><span class="n">size</span> <span class="n">of</span> <span class="n">image</span> <span class="n">to</span> <span class="n">be</span> <span class="n">installed</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The external installer is informed about the size of the image to be
installed, and it can assign resources if it needs. It will answer
with the string <em>ACK</em> or <em>NACK</em>. The first NACK received by SWUpdate
will interrupt the update. After sending the INIT command, the remote
handler will send a sequence of <em>DATA</em> commands, where the second
frame in message will contain chunks of the image to be installed.
It is duty of the external process to take care of the amount of
data transferred and to release resources when the last chunk
is received. For each DATA message, the external process answers with a
<em>ACK</em> or <em>NACK</em> message.</p>
</section>
<section id="swu-forwarder">
<h2>SWU forwarder<a class="headerlink" href="#swu-forwarder" title="Link to this heading"></a></h2>
<p>The SWU forwarder handler can be used to update other systems where SWUpdate
is running. It can be used in case of master / slaves systems, where the master
is connected to the network and the “slaves” are hidden to the external world.
The master is then the only interface to the world. A general SWU can contain
embedded SWU images as single artifacts, and the SWU handler will forward it
to the devices listed in the description of the artifact.
The handler can have a single “url” properties entry with an array of urls. Each url
is the address of a secondary board where SWUpdate is running with webserver activated.
The SWU handler expects to talk with SWUpdate’s embedded webserver. This helps
to update systems where an old version of SWUpdate is running, because the
embedded webserver is a common feature present in all versions.
The handler will send the embedded SWU to all URLs at the same time, and setting
<code class="docutils literal notranslate"><span class="pre">installed-directly</span></code> is supported by this handler.</p>
<img alt="_images/SWUGateway.png" src="_images/SWUGateway.png" />
<p>The following example shows how to set a SWU as artifact and enables
the SWU forwarder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;image.swu&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;swuforward&quot;</span><span class="p">;</span>

                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://192.168.178.41:8080&quot;</span><span class="p">,</span> <span class="s2">&quot;http://192.168.178.42:8080&quot;</span><span class="p">];</span>
                <span class="p">};</span>
        <span class="p">});</span>
</pre></div>
</div>
<p>The SWU forwarder can be used as generic uploader to an URL. This is requires to enable Lua support.
The back channel should still run via Websocket, if the connected server should communicate a progress status.
The handler allows to link an own Lua code that is able to parse the incoming data, and
report an error. The <cite>properties field</cite> should contain the name of the Lua function that
should be called to parse the answer from the remote system. Note that the data passed to Lua
is converted to a string (and null terminated).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;image.swu&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;swuforward&quot;</span><span class="p">;</span>

                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;http://192.168.178.41&quot;</span><span class="p">,</span> <span class="s2">&quot;http://192.168.178.42];</span>
                        <span class="n">parser</span><span class="o">-</span><span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;parse_answer&quot;</span><span class="p">;</span>
                <span class="p">};</span>
        <span class="p">});</span>
</pre></div>
</div>
<p>The parser function should be already loaded. The Lua function receives as input a string with the data
received via the Websocket back channel. The function will read the data and return a single scalar value
of swupdate_status, that is one of swupdate.RECOVERY_STATUS.*.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">parse_answer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">match</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;SUCCESS&#39;</span><span class="p">)</span> <span class="n">then</span>
                <span class="k">return</span> <span class="n">swupdate</span><span class="o">.</span><span class="n">RECOVERY_STATUS</span><span class="o">.</span><span class="n">SUCCESS</span>
        <span class="n">end</span>
        <span class="k">if</span> <span class="n">string</span><span class="o">.</span><span class="n">match</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s1">&#39;FAILURE&#39;</span><span class="p">)</span> <span class="n">then</span>
                <span class="k">return</span> <span class="n">swupdate</span><span class="o">.</span><span class="n">RECOVERY_STATUS</span><span class="o">.</span><span class="n">FAILURE</span>
        <span class="n">end</span>

        <span class="k">return</span> <span class="n">swupdate</span><span class="o">.</span><span class="n">RECOVERY_STATUS</span><span class="o">.</span><span class="n">RUN</span>

<span class="n">end</span><span class="s2">&quot;;</span>
</pre></div>
</div>
<p>The handler evaluates the return value, and stops when one of SUCCESS or FAILURE is returned.</p>
<p>If no parser-function is passed, the handler will run the internal parser used to connect
remote SWUpdate systems, and expects to see a JSON message sent by the Mongoose Webserver.</p>
</section>
<section id="rdiff-handler">
<h2>rdiff handler<a class="headerlink" href="#rdiff-handler" title="Link to this heading"></a></h2>
<p>The rdiff handler adds support for applying binary delta patches generated by
<a class="reference external" href="http://librsync.sourcefrog.net/">librsync’s</a> rdiff tool.</p>
<p>Naturally, the smaller the difference between the diff’s source and target, the
more effective is using this handler rather than shipping the full target, e.g.,
via the image handler. Hence, the most prominent use case for the rdiff handler
is when having a read-only root filesystem and applying a small update like
security fixes or feature additions. If the sweet spot is crossed, an rdiff
patch may even exceed the full target’s size due to necessary patch metadata.
Also note that in order to be most effective, an image to be processed with
rdiff should be built deterministic
(see <a class="reference external" href="https://reproducible-builds.org">reproducible-builds.org</a>).</p>
<p>The rdiff algorithm requires no resources whatsoever on the device as the patch
is fully computed in the backend. Consequently, the backend has to have
knowledge of the current software running on the device in order to compute
a sensible patch. Alike, the patch has to be applied on the device to an
unmodified source as used in the backend for patch computation. This property is
in particular useful for resource-constrained devices as there’s no need for the
device to, e.g., aid in the difference computation.</p>
<p>First, create the signature of the original (base) file via
<code class="docutils literal notranslate"><span class="pre">rdiff</span> <span class="pre">signature</span> <span class="pre">&lt;basefile&gt;</span> <span class="pre">&lt;signaturefile&gt;</span></code>.
Then, create the delta file (i.e., patch) from the original base file to the target
file via <code class="docutils literal notranslate"><span class="pre">rdiff</span> <span class="pre">delta</span> <span class="pre">&lt;signaturefile&gt;</span> <span class="pre">&lt;targetfile&gt;</span> <span class="pre">&lt;deltafile&gt;</span></code>.
The <code class="docutils literal notranslate"><span class="pre">&lt;deltafile&gt;</span></code> is the artifact to be applied via this handler on the device.
Essentially, it mimics running <code class="docutils literal notranslate"><span class="pre">rdiff</span> <span class="pre">patch</span> <span class="pre">&lt;basefile&gt;</span> <span class="pre">&lt;deltafile&gt;</span> <span class="pre">&lt;targetfile&gt;</span></code>
on the device. Naturally for patches, the very same <code class="docutils literal notranslate"><span class="pre">&lt;basefile&gt;</span></code> has to be used
for creating as well as for applying the patch to.</p>
<p>This handler registers itself for handling files and images.
An exemplary sw-description fragment for the files section is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">files</span><span class="p">:</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;rdiff_file&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;file.rdiff.delta&quot;</span><span class="p">;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/file&quot;</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Note that the file referenced to by <code class="docutils literal notranslate"><span class="pre">path</span></code> serves as <code class="docutils literal notranslate"><span class="pre">&lt;basefile&gt;</span></code> and
gets replaced by a temporary file serving as <code class="docutils literal notranslate"><span class="pre">&lt;targetfile&gt;</span></code> while the rdiff
patch processing.</p>
<p>An exemplary sw-description fragment for the images section is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;rdiff_image&quot;</span><span class="p">;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;image.rdiff.delta&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk0p2&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">rdiffbase</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;/dev/mmcblk0p1&quot;</span><span class="p">];</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Here, the property <code class="docutils literal notranslate"><span class="pre">rdiffbase</span></code> qualifies the <code class="docutils literal notranslate"><span class="pre">&lt;basefile&gt;</span></code> while the <code class="docutils literal notranslate"><span class="pre">device</span></code>
attribute designates the <code class="docutils literal notranslate"><span class="pre">&lt;targetfile&gt;</span></code>.
Note that there’s no support for the optional <code class="docutils literal notranslate"><span class="pre">offset</span></code> attribute in the
<code class="docutils literal notranslate"><span class="pre">rdiff_image</span></code> handler as there’s currently no apparent use case for it and
skipping over unchanged content is handled well by the rdiff algorithm.</p>
</section>
<section id="ucfw-handler">
<h2>ucfw handler<a class="headerlink" href="#ucfw-handler" title="Link to this heading"></a></h2>
<p>This handler allows one to update the firmware on a microcontroller connected to
the main controller via UART.
Parameters for setup are passed via sw-description file.  Its behavior can be
extended to be more general.
The protocol is ASCII based. There is a sequence to be done to put the microcontroller
in programming mode, after that the handler sends the data and waits for an ACK from the
microcontroller.</p>
<p>The programming of the firmware shall be:</p>
<ol class="arabic">
<li><p>Enter firmware update mode (bootloader)</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Set “reset line” to logical “low”</p></li>
<li><p>Set “update line” to logical “low”</p></li>
<li><p>Set “reset line” to logical “high”</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Send programming message</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$PROG;&lt;&lt;CS&gt;&gt;&lt;CR&gt;&lt;LF&gt;
</pre></div>
</div>
<p>to the microcontroller.  (microcontroller will remain in programming state)</p>
<ol class="arabic simple" start="3">
<li><p>microcontroller confirms with</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$READY;&lt;&lt;CS&gt;&gt;&lt;CR&gt;&lt;LF&gt;
</pre></div>
</div>
<ol class="arabic" start="4">
<li><p>Data transmissions package based from mainboard to microcontroller package definition:</p>
<blockquote>
<div><ul class="simple">
<li><p>within a package the records are sent one after another without the end of line marker &lt;CR&gt;&lt;LF&gt;</p></li>
<li><p>the package is completed with &lt;CR&gt;&lt;LF&gt;</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The microcontroller requests the next package with $READY;&lt;&lt;CS&gt;&gt;&lt;CR&gt;&lt;LF&gt;</p></li>
<li><p>Repeat step 4 and 5 until the complete firmware is transmitted.</p></li>
<li><p>The keypad confirms the firmware completion with $COMPLETED;&lt;&lt;CS&gt;&gt;&lt;CR&gt;&lt;LF&gt;</p></li>
<li><dl class="simple">
<dt>Leave firmware update mode</dt><dd><ol class="arabic simple">
<li><p>Set “Update line” to logical “high”</p></li>
<li><p>Perform a reset over the “reset line”</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
<p>&lt;&lt;CS&gt;&gt; : checksum. The checksum is calculated as the two’s complement of
the modulo-256 sum over all bytes of the message
string except for the start marker “$”.
The handler expects to get in the properties the setup for the reset
and prog gpios. They should be in this format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">reset</span> <span class="o">=</span> <span class="s2">&quot;&lt;gpiodevice&gt;:&lt;gpionumber&gt;:&lt;activelow&gt;&quot;</span><span class="p">;</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&lt;gpiodevice&gt;:&lt;gpionumber&gt;:&lt;activelow&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
    <span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;microcontroller-image&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ucfw&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/ttymxc5&quot;</span><span class="p">;</span>

        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">reset</span> <span class="o">=</span>  <span class="s2">&quot;/dev/gpiochip0:38:false&quot;</span><span class="p">;</span>
            <span class="n">prog</span> <span class="o">=</span>  <span class="s2">&quot;/dev/gpiochip0:39:false&quot;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
<section id="ssbl-handler">
<h2>SSBL Handler<a class="headerlink" href="#ssbl-handler" title="Link to this heading"></a></h2>
<p>This implements a way to switch two software sets using a duplicated structure saved on the
flash (currently, only NOR flash is supported). Each of the two structures contains address
and size of the image to be loaded by a first loader. A field contain the “age”, and it is
incremented after each switch to show which is the active set.</p>
<table class="docutils align-default" id="id1">
<caption><span class="caption-text">Structure of SSBL Admin</span><a class="headerlink" href="#id1" title="Link to this table"></a></caption>
<tbody>
<tr class="row-odd"><td><p>SSBL Magic Number (29 bit)Name</p></td>
<td><p>Age (3 bit)</p></td>
</tr>
<tr class="row-even"><td colspan="2"><p>Image Address Offset</p></td>
</tr>
<tr class="row-odd"><td colspan="2"><p>Image Size</p></td>
</tr>
</tbody>
</table>
<p>The handler implements a post install script. First, it checks for consistency the two
structures and find the active reading the first 32 bit value with a magic number and the age.
It increments the age and saves the new structure in the inactive copy. After a reboot,
the loader will check it and switch the software set.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;ssblswitch&quot;</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">device</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mtdX&quot;</span><span class="p">,</span> <span class="s2">&quot;mtdY&quot;</span><span class="p">];</span>
                        <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">];</span>
                        <span class="n">imageoffs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0x780000&quot;</span><span class="p">,</span>  <span class="s2">&quot;0xA40000&quot;</span><span class="p">];</span>
                        <span class="n">imagesize</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0x800000&quot;</span><span class="p">,</span> <span class="s2">&quot;0x800000&quot;</span><span class="p">];</span>
                <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Properties in sw-description are all mandatory. They define where the SSBL Administration data
are stored for both sets. Each properties is an array of two entries, containing values for each
of the two SSBL administration.</p>
<table class="docutils align-default" id="id2">
<caption><span class="caption-text">Properties for SSBL handler</span><a class="headerlink" href="#id2" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>device</p></td>
<td><p>string</p></td>
<td><p>MTD device where the SSBL Admin Header is stored</p></td>
</tr>
<tr class="row-odd"><td><p>offset</p></td>
<td><p>hex</p></td>
<td><p>Offset of SSBL header inside the MTD device</p></td>
</tr>
<tr class="row-even"><td><p>imageoffset</p></td>
<td><p>hex</p></td>
<td><p>Offset of the image to be loaded by a bootloader
when this SSBL is set.</p></td>
</tr>
<tr class="row-odd"><td><p>imagesize</p></td>
<td><p>hex</p></td>
<td><p>Size of the image to be loaded by a bootloader
when this SSBL is set.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="readback-handler">
<h2>Readback Handler<a class="headerlink" href="#readback-handler" title="Link to this heading"></a></h2>
<p>To verify that an image was written properly, this readback handler calculates
the sha256 hash of a partition (or part of it) and compares it against a given
hash value.</p>
<p>The following example explains how to use this handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk2p1&quot;</span><span class="p">;</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;readback&quot;</span><span class="p">;</span>
    <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">sha256</span> <span class="o">=</span> <span class="s2">&quot;e7afc9bd98afd4eb7d8325196d21f1ecc0c8864d6342bfc6b6b6c84eac86eb42&quot;</span><span class="p">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;184728576&quot;</span><span class="p">;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
<p>Properties <code class="docutils literal notranslate"><span class="pre">size</span></code> and <code class="docutils literal notranslate"><span class="pre">offset</span></code> are optional, all the other properties are mandatory.</p>
<table class="docutils align-default" id="id3">
<caption><span class="caption-text">Properties for readback handler</span><a class="headerlink" href="#id3" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>device</p></td>
<td><p>string</p></td>
<td><p>The partition which shall be verified.</p></td>
</tr>
<tr class="row-odd"><td><p>type</p></td>
<td><p>string</p></td>
<td><p>Identifier for the handler.</p></td>
</tr>
<tr class="row-even"><td><p>sha256</p></td>
<td><p>string</p></td>
<td><p>Expected sha256 hash of the partition.</p></td>
</tr>
<tr class="row-odd"><td><p>size</p></td>
<td><p>string</p></td>
<td><p>Data size (in bytes) to be verified.
If 0 or not set, the handler will get the
partition size from the device.</p></td>
</tr>
<tr class="row-even"><td><p>offset</p></td>
<td><p>string</p></td>
<td><p>Offset (in bytes) to the start of the partition.
If not set, default value 0 will be used.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="copy-handler">
<h2>Copy handler<a class="headerlink" href="#copy-handler" title="Link to this heading"></a></h2>
<p>The copy handler copies one source to a destination. It is a script handler, and no artifact in the SWU is associated
with the handler.  It can be used to copy configuration data, or parts that should be taken by the current installation.
It requires the mandatory  property (<cite>copyfrom</cite>), while device contains the destination path.
The handler performs a byte copy, and it does not matter which is the source - it can be a file or a partition.
An optional <cite>type</cite> field can set if the handler is active as pre or postinstall script. If not set, the handler
is called twice.</p>
<table class="docutils align-default" id="id4">
<caption><span class="caption-text">Attributes for copy handler</span><a class="headerlink" href="#id4" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>device</p></td>
<td><p>string</p></td>
<td><p>If set, it is the destination.</p></td>
</tr>
<tr class="row-odd"><td><p>type</p></td>
<td><p>string</p></td>
<td><p>One of “preinstall” or “postinstall”</p></td>
</tr>
</tbody>
</table>
<table class="docutils align-default" id="id5">
<caption><span class="caption-text">Properties for copy handler</span><a class="headerlink" href="#id5" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>size</p></td>
<td><p>string</p></td>
<td><p>Data size (in bytes) to be copied.
If 0 or not set, the handler will try to find the
size from the device.</p></td>
</tr>
<tr class="row-odd"><td><p>chain</p></td>
<td><p>string</p></td>
<td><p>Handler to be called to install the data read
from the “copyfrom” source.</p></td>
</tr>
<tr class="row-even"><td><p>recursive</p></td>
<td><p>string</p></td>
<td><p>Recursive copy if copyfrom is a directory
(“true” or “false”)</p></td>
</tr>
<tr class="row-odd"><td><p>create-
destination</p></td>
<td><p>string</p></td>
<td><p>Create the destination path if it does not exist
(“true” or “false”)</p></td>
</tr>
</tbody>
</table>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span> <span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk2p1&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;copy&quot;</span><span class="p">;</span>
        <span class="n">properties</span> <span class="p">:</span> <span class="p">{</span>
                <span class="n">copyfrom</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk2p2&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;postinstall&quot;</span><span class="p">;</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="bootloader-handler">
<h2>Bootloader handler<a class="headerlink" href="#bootloader-handler" title="Link to this heading"></a></h2>
<p>The bootloader handler allows to set bootloader’s environment with a file. The file should have the format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Comments are allowed using the hash char</span>

<span class="n">varname</span><span class="o">=</span><span class="n">value</span>
</pre></div>
</div>
<p>Empty lines are skipped. This simplifies the update of the whole environment instead of setting each variable inside the
“bootenv” section in sw-description. The property <em>nooverride</em> allows to skip variables that are already set in sw-description. If
not set, variables set in bootenv are overwritten.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;uEnv.txt&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;bootloader&quot;</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">nooverride</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">);</span>

<span class="n">bootenv</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;bootenv01key&quot;</span><span class="p">;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;SOME VALUE&quot;</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>In the example above, bootenv01key is not overwritten by a value in uEnv.txt because the flag “nooverride” is set.</p>
</section>
<section id="archive-handler">
<h2>Archive handler<a class="headerlink" href="#archive-handler" title="Link to this heading"></a></h2>
<p>The archive handler extracts an archive to a destination path.
It supports whatever format libarchive has been compiled to support, for example even if SWUpdate
itself has no direct support for xz it can be possible to extract tar.xz files with it.</p>
<p>The attribute <cite>preserve-attributes</cite> must be set to preserve timestamps. uid/gid (numeric) and
extended attributes. File modes (such as chmod 0755/0600) are always preserved.</p>
<p>The property <cite>create-destination</cite> can be set to the string <cite>true</cite> to have SWUpdate create
the destination path before extraction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">files</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;examples.tar.zst&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;archive&quot;</span><span class="p">;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/extract/here&quot;</span><span class="p">;</span>
                <span class="n">preserve</span><span class="o">-</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                <span class="n">installed</span><span class="o">-</span><span class="n">directly</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
                <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">create</span><span class="o">-</span><span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
<section id="disk-partitioner">
<h2>Disk partitioner<a class="headerlink" href="#disk-partitioner" title="Link to this heading"></a></h2>
<p>This handler creates or modifies partitions using the library libfdisk. Handler must be put into
the <cite>partitions</cite> section of sw-description. Setup for each partition is put into the <cite>properties</cite> field
of sw-description.
After writing the partition table it may create a file system on selected partitions.
(Available only if CONFIG_DISKFORMAT is set.)</p>
<table class="docutils align-default" id="id6">
<caption><span class="caption-text">Properties for diskpart handler</span><a class="headerlink" href="#id6" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>labeltype</p></td>
<td><p>string</p></td>
<td><p>“gpt” or “dos”</p></td>
</tr>
<tr class="row-odd"><td><p>nolock</p></td>
<td><p>string</p></td>
<td><p>“true” or “false” (default=false)
This is like a force. If it is set, a lock failure
will be ignored(lock will still be attempted).</p></td>
</tr>
<tr class="row-even"><td><p>noinuse</p></td>
<td><p>string</p></td>
<td><p>“true” or “false” (default=false)
If set, it does not require the device to be not
in use (mounted, etc.)</p></td>
</tr>
<tr class="row-odd"><td><p>partition-X</p></td>
<td><p>array</p></td>
<td><p>Array of values belonging to the partition number X</p></td>
</tr>
</tbody>
</table>
<p>For each partition, an array of couples key=value must be given. The following keys are
supported:</p>
<table class="docutils align-default" id="id7">
<caption><span class="caption-text">Setup for a disk partition</span><a class="headerlink" href="#id7" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>size</p></td>
<td><p>string</p></td>
<td><p>Size of partition. K, M and G can be used for
Kilobytes, Megabytes and Gigabytes.</p></td>
</tr>
<tr class="row-odd"><td><p>start</p></td>
<td><p>integer</p></td>
<td><p>First sector for the partition</p></td>
</tr>
<tr class="row-even"><td><p>name</p></td>
<td><p>string</p></td>
<td><p>Name of the partition</p></td>
</tr>
<tr class="row-odd"><td><p>type</p></td>
<td><p>string</p></td>
<td><p>Type of partition, it has two different meanings.
It is the hex code for DOS (MBR) partition table
or it is the string identifier in case of GPT.</p></td>
</tr>
<tr class="row-even"><td><p>dostype</p></td>
<td><p>string</p></td>
<td><p>Type of DOS (MBR) partition entry when using a
table with a “gpt” labeltype.
Using this option will create a hybrid MBR table.
It is the hex code for DOS (MBR) partition table.
This would typically be used when one wants to use
a GPT formatted disk with a board that requires a
dos table entry for initial bootstrapping.
Note: A maximum of 3 partitions can have a dostype
specified, this limit only applies to dos table
entries and does not affect partitions without a
dostype specified.</p></td>
</tr>
<tr class="row-odd"><td><p>fstype</p></td>
<td><p>string</p></td>
<td><p>Optional filesystem type to be created on the
partition. If no fstype key is given, no file
will be created on the corresponding partition.
vfat / ext2 / ext3 /ext4 / btrfs
file system is supported</p></td>
</tr>
<tr class="row-even"><td><p>partuuid</p></td>
<td><p>string</p></td>
<td><p>The partition UUID (GPT only). If omitted, a UUID
will be generated automatically.</p></td>
</tr>
<tr class="row-odd"><td><p>flag</p></td>
<td><p>string</p></td>
<td><p>The following flags are supported:
Dos Partition : “boot” set bootflag</p></td>
</tr>
<tr class="row-even"><td><p>force</p></td>
<td><p>string</p></td>
<td><p>If set to “true”, existing file-system shall be
overwritten uncoditionally.
Default value is “false”.</p></td>
</tr>
</tbody>
</table>
<p>GPT example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partitions</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
   <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;diskpart&quot;</span><span class="p">;</span>
   <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/sde&quot;</span><span class="p">;</span>
   <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">labeltype</span> <span class="o">=</span> <span class="s2">&quot;gpt&quot;</span><span class="p">;</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;size=64M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=2048&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name=bigrootfs&quot;</span><span class="p">,</span> <span class="s2">&quot;type=C12A7328-F81F-11D2-BA4B-00A0C93EC93B&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=256M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=133120&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name=ldata&quot;</span><span class="p">,</span> <span class="s2">&quot;type=EBD0A0A2-B9E5-4433-87C0-68B6B72699C7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fstype=vfat&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">3</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=512M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=657408&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name=log&quot;</span><span class="p">,</span> <span class="s2">&quot;fstype =ext4&quot;</span><span class="p">,</span> <span class="mi">63</span><span class="n">DAF</span><span class="o">-</span><span class="mi">8483</span><span class="o">-</span><span class="mi">4772</span><span class="o">-</span><span class="mf">8E79</span><span class="o">-</span><span class="mi">3</span><span class="n">D69D8477DE4</span><span class="s2">&quot;];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">4</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=4G&quot;</span><span class="p">,</span> <span class="s2">&quot;start=1705984&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name=system&quot;</span><span class="p">,</span>  <span class="s2">&quot;type=0FC63DAF-8483-4772-8E79-3D69D8477DE4&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">5</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=512M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=10094592&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name=part5&quot;</span><span class="p">,</span>  <span class="s2">&quot;type=0FC63DAF-8483-4772-8E79-3D69D8477DE4&quot;</span><span class="p">];</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>MBR Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partitions</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
   <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;diskpart&quot;</span><span class="p">;</span>
   <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/sde&quot;</span><span class="p">;</span>
   <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">labeltype</span> <span class="o">=</span> <span class="s2">&quot;dos&quot;</span><span class="p">;</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;size=64M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=2048&quot;</span><span class="p">,</span> <span class="s2">&quot;name=bigrootfs&quot;</span><span class="p">,</span> <span class="s2">&quot;type=0x83&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=256M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=133120&quot;</span><span class="p">,</span> <span class="s2">&quot;name=ldata&quot;</span><span class="p">,</span> <span class="s2">&quot;type=0x83&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">3</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=256M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=657408&quot;</span><span class="p">,</span> <span class="s2">&quot;name=log&quot;</span><span class="p">,</span> <span class="s2">&quot;type=0x83&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">4</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=6G&quot;</span><span class="p">,</span> <span class="s2">&quot;start=1181696&quot;</span><span class="p">,</span> <span class="s2">&quot;name=system&quot;</span><span class="p">,</span>  <span class="s2">&quot;type=0x5&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">5</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=512M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=1183744&quot;</span><span class="p">,</span> <span class="s2">&quot;name=part5&quot;</span><span class="p">,</span>  <span class="s2">&quot;type=0x83&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">6</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=512M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=2234368&quot;</span><span class="p">,</span> <span class="s2">&quot;name=part6&quot;</span><span class="p">,</span>  <span class="s2">&quot;type=0x83&quot;</span><span class="p">];</span>
        <span class="n">partition</span><span class="o">-</span><span class="mi">7</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;size=16M&quot;</span><span class="p">,</span> <span class="s2">&quot;start=3284992&quot;</span><span class="p">,</span> <span class="s2">&quot;name=part7&quot;</span><span class="p">,</span> <span class="s2">&quot;type=0x6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fstype=vfat&quot;</span><span class="p">];</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="toggleboot-handler">
<h2>Toggleboot Handler<a class="headerlink" href="#toggleboot-handler" title="Link to this heading"></a></h2>
<p>This handler is a script handler. It turns on the bootflag for one of a disk partition
if the partition table is DOS. It reports an error if the table is GPT.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">script</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
   <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;toggleboot&quot;</span><span class="p">;</span>
   <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/sde&quot;</span><span class="p">;</span>
   <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">partition</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="gpt-partition-handler">
<h2>GPT Partition Handler<a class="headerlink" href="#gpt-partition-handler" title="Link to this heading"></a></h2>
<section id="gpt-partition-installer">
<h3>GPT Partition Installer<a class="headerlink" href="#gpt-partition-installer" title="Link to this heading"></a></h3>
<p>There is a handler gptpart that allows writing an image into a gpt partition selected by
the name. This handler do not modify the gpt partition (type, size, …), it just writes
the image in the GPT partition.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;u-boot.bin&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;gptpart&quot;</span><span class="p">;</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/vdb&quot;</span><span class="p">;</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;u-boot-1&quot;</span><span class="p">;</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="s2">&quot;1024&quot;</span><span class="p">;</span>
        <span class="p">},</span>
        <span class="p">{</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;kernel.bin&quot;</span><span class="p">;</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;gptpart&quot;</span><span class="p">;</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/vdb&quot;</span><span class="p">;</span>
                <span class="n">volume</span> <span class="o">=</span> <span class="s2">&quot;kernel-1&quot;</span><span class="p">;</span>
        <span class="p">},</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
<section id="gpt-partition-swap">
<h3>GPT Partition Swap<a class="headerlink" href="#gpt-partition-swap" title="Link to this heading"></a></h3>
<p>There is a handler gptswap that allow to swap gpt partitions after all the images were flashed.
This handler only swaps the name of the partition. It could be useful for a dual bank strategy.
This handler is a script for the point of view of SWUpdate, so the node that provides it should
be added in the section scripts.</p>
<p>Simple example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span>
        <span class="p">{</span>
                <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;gptswap&quot;</span><span class="p">;</span>
                <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/vdb&quot;</span><span class="p">;</span>
                <span class="n">properties</span> <span class="o">=</span>
                <span class="p">{</span>
                        <span class="n">swap</span><span class="o">-</span><span class="mi">0</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;u-boot-0&quot;</span> <span class="p">,</span> <span class="s2">&quot;u-boot-1&quot;</span> <span class="p">];</span>
                        <span class="n">swap</span><span class="o">-</span><span class="mi">1</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;kernel-0&quot;</span> <span class="p">,</span> <span class="s2">&quot;kernel-1&quot;</span> <span class="p">];</span>
                <span class="p">};</span>
        <span class="p">},</span>
<span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="diskformat-handler">
<h2>Diskformat Handler<a class="headerlink" href="#diskformat-handler" title="Link to this heading"></a></h2>
<p>This handler checks if the device already has a file system of the specified
type. (Available only if CONFIG_DISKFORMAT is set.)
If the file system does not yet exist, it will be created.
In case an existing file system shall be overwritten, this can be achieved
by setting the property <code class="docutils literal notranslate"><span class="pre">force</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partitions</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;diskformat&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/loop0p1&quot;</span><span class="p">;</span>

        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">fstype</span> <span class="o">=</span> <span class="s2">&quot;vfat&quot;</span><span class="p">;</span>
                <span class="n">force</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
</section>
<section id="unique-uuid-handler">
<h2>Unique UUID Handler<a class="headerlink" href="#unique-uuid-handler" title="Link to this heading"></a></h2>
<p>This handler checks if the device already has a filesystems with a provide UUID. This is helpful
in case the bootloader chooses the device to boot from the UUID and not from the partition number.
One use case is with the GRUB bootloader when GRUB_DISABLE_LINUX_UUID is not set, as usual on
Linux Distro as Debian or Ubuntu.</p>
<p>The handler iterates all UUIDs given in sw-description and raises error if one of them is
found on the device. It is a partition handler and it runs before any image is installed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partitions</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;uniqueuuid&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">fs</span><span class="o">-</span><span class="n">uuid</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;21f16cae-612f-4bc6-8ef5-e68cc9dc4380&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;18e12df1-d8e1-4283-8727-37727eb4261d&quot;</span><span class="p">];</span>
        <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="btrfs-handler">
<h2>BTRFS Handler<a class="headerlink" href="#btrfs-handler" title="Link to this heading"></a></h2>
<section id="btrfs-partition-handler">
<h3>BTRFS Partition Handler<a class="headerlink" href="#btrfs-partition-handler" title="Link to this heading"></a></h3>
<p>This handler is activated if support for BTRFS is on. It allows to created and delete subvolumes
during an update.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">partitions</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;btrfs&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/loop0p1&quot;</span><span class="p">;</span>

        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">command</span> <span class="o">=</span> <span class="o">&lt;</span> <span class="n">one</span> <span class="n">of</span> <span class="n">create</span><span class="s2">&quot; or &quot;</span><span class="n">delete</span><span class="s2">&quot; &gt;</span>
                <span class="n">path</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">path</span> <span class="k">for</span> <span class="n">the</span> <span class="n">subvolume</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">mount</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="ow">or</span> <span class="n">missing</span><span class="p">;</span>
                <span class="n">create</span><span class="o">-</span><span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="ow">or</span> <span class="n">missing</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>If <cite>mount</cite> is set, SWUpdate will mount the device and the path is appended to the
mountpoint used with mount. If device is already mounted, path is the absolute path.</p>
</section>
<section id="btrfs-snapshot-handler">
<h3>BTRFS Snapshot Handler<a class="headerlink" href="#btrfs-snapshot-handler" title="Link to this heading"></a></h3>
<p>The handler allows to install a BTRFS snapshot created with the “btrfs send” command.
SWUpdate is using the external “btrfs” utility, that must be installed on the target,
and “btrfs receive” is executed by sending the stream to the command.</p>
<p>All generic features are available, that means that an artifact can be streamed by
using the “installed-directly” attribute.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;btrfs-snapshot&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;btrfs-receive&quot;</span><span class="p">;</span>
        <span class="n">device</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">optional</span><span class="p">,</span> <span class="n">device</span> <span class="k">with</span> <span class="n">BTRFS</span> <span class="n">fs</span><span class="p">,</span> <span class="n">must</span> <span class="n">be</span> <span class="nb">set</span> <span class="k">if</span> <span class="n">tomount</span> <span class="ow">is</span> <span class="s2">&quot;true&quot;</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">path</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">mandatory</span><span class="p">,</span> <span class="n">path</span> <span class="n">where</span> <span class="n">to</span> <span class="n">install</span> <span class="n">subvolume</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">btrfs</span><span class="o">-</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">optional</span><span class="p">,</span> <span class="n">path</span> <span class="n">to</span> <span class="n">btrfs</span> <span class="n">command</span><span class="o">&gt;</span><span class="p">;</span>
                <span class="n">tomount</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">boolean</span><span class="p">,</span> <span class="n">optional</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span> <span class="o">/</span> <span class="s2">&quot;false&quot;</span> <span class="o">&gt;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">})</span>
</pre></div>
</div>
<p>If <cite>tomount</cite> is set, SWUpdate will temporary mount “device” as BTRFS filesystem and will try to install
the snapshot to <cite>path</cite>. <cite>btrfs-cmd</cite> is optional, fallback is /usr/bin/btrfs.</p>
</section>
</section>
<section id="generic-executor-handler">
<h2>Generic Executor Handler<a class="headerlink" href="#generic-executor-handler" title="Link to this heading"></a></h2>
<p>The BTRFS snapshot handler requires to stream an artifact after normal handling
(decompression, decryption, etc.) to the external command “btrfs” without any temporary copy.
The same infrastructure can be used to stream any artifact to any arbitrary external command
that accepts the stream as stdin. This is done with the “executor” handler.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;executor&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">mandatory</span><span class="p">,</span> <span class="n">command</span> <span class="n">to</span> <span class="n">be</span> <span class="n">executed</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">pipe</span><span class="o">&gt;</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If <cite>create-destination</cite> is set, SWUpdate will create the destination path of the subvolume before
creating it.</p>
</section>
<section id="delta-update-handler">
<h2>Delta Update Handler<a class="headerlink" href="#delta-update-handler" title="Link to this heading"></a></h2>
<p>The handler processes a ZCHUNK header and finds which chunks should be downloaded
after generating the corresponding header of the running artifact to be updated.
The handler uses just a couple of attributes from the main setup, and gets more information
from the properties. The attributes are then passed to a secondary handler that
will install the artifact after the delta handler has assembled it.
The handler requires ZST because this is the compression format for Zchunk.</p>
<p>The SWU must just contain the ZCK’s header, while the ZCK file is put as it is on the server.
The utilities in Zchunk project are used to build the ZCK file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">zck</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">h</span> <span class="n">sha256</span> <span class="o">&lt;</span><span class="n">artifact</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>This will generates a file &lt;arifact&gt;.zck. To extract the header, use the <cite>zck_read_header</cite>
utility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>HSIZE=`zck_read_header -v &lt;artifact&gt;.zck | grep &quot;Header size&quot; | cut -d&#39;:&#39; -f2`
dd if=&lt;artifact&gt;.zck of=&lt;artifact&gt;.header bs=1 count=$((HSIZE))
</pre></div>
</div>
<p>The resulting header file must be packed inside the SWU.</p>
<table class="docutils align-default" id="id8">
<caption><span class="caption-text">Properties for delta update handler</span><a class="headerlink" href="#id8" title="Link to this table"></a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>url</p></td>
<td><p>string</p></td>
<td><p>This is the URL from where the handler will
download the missing chunks.
The server must support byte range header.</p></td>
</tr>
<tr class="row-odd"><td><p>source</p></td>
<td><p>string</p></td>
<td><p>name of the device or file to be used for
the comparison.</p></td>
</tr>
<tr class="row-even"><td><p>chain</p></td>
<td><p>string</p></td>
<td><p>this is the name (type) of the handler
that is called after reassembling
the artifact.</p></td>
</tr>
<tr class="row-odd"><td><p>max-ranges</p></td>
<td><p>string</p></td>
<td><p>Max number of ranges that a server can
accept. Default value (150) should be ok
for most servers.</p></td>
</tr>
<tr class="row-even"><td><p>zckloglevel</p></td>
<td><p>string</p></td>
<td><p>this sets the log level of the zcklib.
Logs are intercepted by SWupdate and
appear in SWUpdate’s log.
Value is one of debug,info
warn,error,none</p></td>
</tr>
<tr class="row-odd"><td><p>debug-chunks</p></td>
<td><p>string</p></td>
<td><p>“true”, default is not set.
This activates more verbose debugging
output and the list of all chunks is
printed, and it reports if a chunk
is downloaded  or copied from the source.</p></td>
</tr>
<tr class="row-even"><td><p>source-size</p></td>
<td><p>string</p></td>
<td><p>This limits the index of the source
It is helpful in case of filesystem in much
bigger partition. It has the value for the size
or it can be set to “detect” and the handler
will try to find the effective size of fs.</p></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;software.header&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;delta&quot;</span><span class="p">;</span>

        <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk0p2&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://examples.com/software.zck&quot;</span><span class="p">;</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="s2">&quot;raw&quot;</span><span class="p">;</span>
                <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;/dev/mmcblk0p3&quot;</span><span class="p">;</span>
                <span class="n">zckloglevel</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span><span class="p">;</span>
                <span class="o">/*</span> <span class="n">debug</span><span class="o">-</span><span class="n">chunks</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">;</span> <span class="o">*/</span>
        <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="memory-issue-with-zchunk">
<h3>Memory issue with zchunk<a class="headerlink" href="#memory-issue-with-zchunk" title="Link to this heading"></a></h3>
<p>SWUpdate will create the header from the current version, often from a block partition. As default,
Zchunk creates a temporary file with all chunks in /tmp, that is at the end concatenated to the
header and written to the destination file. This means that an amount of memory equal to the
partition (SWUpdate does not compress the chunks) is required. This was solved with later version
of Zchunk - check inside zchunk code if ZCK_NO_WRITE is supported.</p>
</section>
</section>
<section id="docker-handlers">
<h2>Docker Handlers<a class="headerlink" href="#docker-handlers" title="Link to this heading"></a></h2>
<p>To improve containers update, a docker set of handlers implements part of the API to communicate
with the docker daemon. Podman (another container solution) has a compatibility layer for
docker REST API and could be used as well, but SWUpdate is currently not checking if a podman
daemon must be started.</p>
<p>Goal of these handlers is just to provide the few API to update images and start containers - it
does not implement the full API.</p>
<section id="docker-load-image">
<h3>Docker Load Image<a class="headerlink" href="#docker-load-image" title="Link to this heading"></a></h3>
<p>This handler allow to load an image without copying temporarily and push it to the docker daemon.
It implements the /images/load entry point., and it is implemented as “image” handler. The file
should be in a format accepted by docker.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;docker-image.tar&quot;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_imageload&quot;</span><span class="p">;</span>
        <span class="n">installed</span><span class="o">-</span><span class="n">directly</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The handler checks return value (JSON message) from the daemon, and returns with success if the image
is added.</p>
<p>In case the file must be decompressed, SWUpdate requires the size of the decompressed image to be
passed to the daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">images</span><span class="p">:</span> <span class="p">(</span>
<span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;alpine.tar.gz&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_imageload&quot;</span><span class="p">;</span>
        <span class="n">installed</span><span class="o">-</span><span class="n">directly</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="s2">&quot;zlib&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
             <span class="n">decompressed</span><span class="o">-</span><span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;5069312&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="docker-remove-image">
<h3>Docker Remove Image<a class="headerlink" href="#docker-remove-image" title="Link to this heading"></a></h3>
<p>It is implemented as script (post install).
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_imagedelete&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;alpine:3.4&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="docker-delete-unused-images">
<h3>Docker Delete Unused Images<a class="headerlink" href="#docker-delete-unused-images" title="Link to this heading"></a></h3>
<p>It is implemented as script (post install).
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_imageprune&quot;</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="docker-container-create">
<h3>Docker: container create<a class="headerlink" href="#docker-container-create" title="Link to this heading"></a></h3>
<p>It is implemented as post-install script. The script itself is the json file passed
to the daemon to configure and set the container. The container is just created, not started.</p>
<p>For example, having this hello-world.json file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
        <span class="s2">&quot;Image&quot;</span><span class="p">:</span> <span class="s2">&quot;hello-world&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HostConfig&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;RestartPolicy&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;always&quot;</span>
                <span class="p">},</span>
        <span class="s2">&quot;AutoRemove&quot;</span><span class="p">:</span> <span class="n">false</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Creating the container can be done in sw-description with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;hello-world.json&quot;</span><span class="p">;</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_containercreate&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;helloworld&quot;</span><span class="p">;</span> <span class="o">/*</span> <span class="n">Name</span> <span class="n">of</span> <span class="n">container</span> <span class="o">*/</span>
        <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="docker-remove-container">
<h3>Docker Remove Container<a class="headerlink" href="#docker-remove-container" title="Link to this heading"></a></h3>
<p>It is implemented as script (post install).
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_containerdelete&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;helloworld&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
<section id="docker-start-stop-containers">
<h3>Docker : Start / Stop containers<a class="headerlink" href="#docker-start-stop-containers" title="Link to this heading"></a></h3>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_containerstart&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;helloworld&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="p">:</span> <span class="p">(</span> <span class="p">{</span>
        <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;docker_containerstop&quot;</span><span class="p">;</span>
        <span class="n">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;helloworld&quot;</span><span class="p">;</span>
        <span class="p">};</span>
<span class="p">});</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="asym_encrypted_images.html" class="btn btn-neutral float-left" title="Asymmetrically Encrypted Update Images" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="mongoose.html" class="btn btn-neutral float-right" title="Mongoose daemon mode" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2025, Stefano Babic.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>